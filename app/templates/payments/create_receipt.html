{% extends "base.html" %}

{% block title %}Payment Entry - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-4" x-data="paymentForm()">
    <!-- Page Header -->
    <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Payment Entry</h1>
        <p class="text-sm text-gray-600">Record supplier payment with invoice settlement</p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6">
        {% if error %}
        <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
            {{ error }}
        </div>
        {% endif %}

        <form method="POST" action="/payments/receipt/create" class="space-y-4">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Company</label>
                    <input type="text" x-ref="companyField" value="{{ current_company.name }}" readonly class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded bg-gray-50">
                </div>
                <div>
                    <label for="supplier_id" class="block text-xs font-medium text-gray-700 mb-1">Supplier *</label>
                    <input type="hidden" name="supplier_id" x-model="supplierId">
                    <div class="relative" @click.outside="showSupplierDropdown = false">
                        <input type="text" x-ref="supplierInput" x-model="supplierSearch" @input="filterSuppliers" @focus="showSupplierDropdown = true; filterSuppliers()" @keydown="handleSupplierKeydown($event)" placeholder="Search supplier..." class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500" autocomplete="off">
                        <div x-show="showSupplierDropdown && (filteredSuppliers.length > 0 || supplierSearch.length > 0)" x-cloak class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                            <template x-for="(s, idx) in filteredSuppliers" :key="s._id">
                                <div @mousedown.prevent @click="selectSupplier(s)" :class="idx === supplierSelectedIndex ? 'bg-blue-100' : 'hover:bg-blue-50'" class="px-2 py-1.5 cursor-pointer text-sm" x-text="s.name"></div>
                            </template>
                            <div @mousedown.prevent @click="openSupplierModal()" :class="filteredSuppliers.length === supplierSelectedIndex ? 'bg-green-100' : 'hover:bg-green-50'" class="px-2 py-1.5 cursor-pointer text-sm text-green-600 font-medium border-t">+ Add New Supplier</div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="payment_type" class="block text-xs font-medium text-gray-700 mb-1">Payment Type *</label>
                    <select id="payment_type" name="payment_type" required x-model="paymentType" @change="togglePaymentFields" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="cheque">Cheque</option>
                        <option value="online">Online Payment</option>
                    </select>
                </div>
                <div>
                    <label for="payment_date" class="block text-xs font-medium text-gray-700 mb-1">Date *</label>
                    <input type="date" id="payment_date" name="payment_date" required :value="new Date().toISOString().split('T')[0]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label for="amount" class="block text-xs font-medium text-gray-700 mb-1">Amount *</label>
                    <input type="number" id="amount" name="amount" step="0.01" required x-model="amount" @input="distributePaymentOnChange" class="w-full px-2 py-1.5 text-sm border rounded focus:ring-1" :class="amount > disbursement ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-blue-500'">
                    <p x-show="amount > disbursement" class="text-xs text-red-600 mt-1">Amount cannot exceed Total Disbursement (₹<span x-text="disbursement.toFixed(2)"></span>)</p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Bank</label>
                    <div class="relative" @click.outside="showBankDropdown = false">
                        <input type="text" x-model="bankSearch" @input="searchBanks" @focus="showBankDropdown = true" @keydown="handleBankKeydown($event)" placeholder="Search bank..." class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500" autocomplete="off">
                        <input type="hidden" name="bank_name" x-model="selectedBank">
                        <div x-show="showBankDropdown && (filteredBanks.length > 0 || bankSearch.length > 0)" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                            <template x-for="(bank, idx) in filteredBanks" :key="idx">
                                <div @click="selectBank(bank)" :class="idx === bankSelectedIndex ? 'bg-blue-100' : 'hover:bg-blue-50'" class="px-2 py-1.5 cursor-pointer text-sm" x-text="bank.bank_name + ' - ' + bank.account_number"></div>
                            </template>
                            <div @click.prevent="openBankModal()" :class="filteredBanks.length === bankSelectedIndex ? 'bg-green-100' : 'hover:bg-green-50'" class="px-2 py-1.5 cursor-pointer text-sm text-green-600 font-medium border-t">+ Add New Bank</div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="cheque_no" class="block text-xs font-medium text-gray-700 mb-1" x-text="paymentType === 'cheque' ? 'Cheque No *' : 'Transaction No'"></label>
                    <input type="text" id="cheque_no" name="cheque_no" :required="paymentType === 'cheque'" :disabled="paymentType === 'online'" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500" :class="paymentType === 'online' ? 'bg-gray-100' : ''">
                </div>
                <div>
                    <label for="rr" class="block text-xs font-medium text-gray-700 mb-1">RR</label>
                    <input type="text" id="rr" name="rr" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label for="effect_on_passbook" class="block text-xs font-medium text-gray-700 mb-1">Passbook Effect</label>
                    <select id="effect_on_passbook" name="effect_on_passbook" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div>
                    <label for="cheque_amount" class="block text-xs font-medium text-gray-700 mb-1">Cheque Amount</label>
                    <input type="number" id="cheque_amount" name="cheque_amount" step="0.01" x-model="amount" readonly class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded bg-gray-50">
                </div>
                <div>
                    <label for="disbursement" class="block text-xs font-medium text-gray-700 mb-1">Disburse *</label>
                    <input type="number" id="disbursement" name="disbursement" step="0.01" required x-model="disbursement" @input="calculateBalance" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label for="balance_amount" class="block text-xs font-medium text-gray-700 mb-1">Balance</label>
                    <input type="number" id="balance_amount" name="balance_amount" step="0.01" x-model="balanceAmount" readonly class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded bg-gray-50">
                </div>
                <input type="hidden" name="selected_invoices" :value="JSON.stringify(getSelectedInvoicesData())">
            </div>

            <div x-show="invoices.length > 0">
                <!-- Mobile View -->
                <div class="md:hidden space-y-3">
                    <template x-for="inv in invoices" :key="inv.id">
                        <div :class="selectedInvoices.includes(inv.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200'" class="border-2 rounded-lg p-3 space-y-2">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-2">
                                    <input type="checkbox" :value="inv.id" @change="toggleInvoice(inv)" :checked="selectedInvoices.includes(inv.id)" :disabled="!selectedInvoices.includes(inv.id) && amount > 0 && amount <= disbursement" class="mt-1 rounded border-gray-300">
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900" x-text="inv.invoice_no"></div>
                                        <div class="text-xs text-gray-500" x-text="inv.invoice_date"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div><span class="text-gray-600">Quality:</span> <span x-text="inv.quality"></span></div>
                                <div class="grid grid-cols-2 gap-1">
                                    <div><span class="text-gray-600">Kg:</span> <span x-text="inv.total_kg.toFixed(2)"></span></div>
                                    <div><span class="text-gray-600">Rate/Kg:</span> <span x-text="'₹' + inv.rate_per_kg.toFixed(2)"></span></div>
                                </div>
                            </div>
                            <div class="border-t pt-2 space-y-1 text-xs">
                                <div class="flex justify-between"><span class="text-gray-600">Amount:</span> <span class="font-medium" x-text="'₹' + inv.net_rs.toFixed(2)"></span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Paid:</span> <span class="text-green-600" x-text="'₹' + inv.total_paid.toFixed(2)"></span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Outstanding:</span> <span class="font-semibold text-red-600" x-text="'₹' + inv.outstanding.toFixed(2)"></span></div>
                            </div>
                            <div x-show="selectedInvoices.includes(inv.id)" class="pt-2 border-t">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Pay Amount</label>
                                <input type="number" :value="invoicePayments[inv.id] || 0" @input="updateInvoicePayment(inv.id, $event.target.value)" step="0.01" class="w-full px-2 py-1.5 text-sm border rounded">
                            </div>
                        </div>
                    </template>
                    <div class="bg-gray-50 rounded-lg p-3 border-2 border-gray-300">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700">Total Disbursement:</span>
                            <span class="text-lg font-bold text-blue-600" x-text="'₹' + disbursement.toFixed(2)"></span>
                        </div>
                    </div>
                </div>
                <!-- Desktop View -->
                <div class="hidden md:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-2 text-center font-medium text-gray-700">Select</th>
                            <th class="px-2 py-2 text-left font-medium text-gray-700">Invoice No</th>
                            <th class="px-2 py-2 text-left font-medium text-gray-700">Date</th>
                            <th class="px-2 py-2 text-left font-medium text-gray-700">Quality</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Kg</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Rate/Kg</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Amount</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Paid</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Outstanding</th>
                            <th class="px-2 py-2 text-right font-medium text-gray-700">Pay Amount</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="inv in invoices" :key="inv.id">
                            <tr :class="selectedInvoices.includes(inv.id) ? 'bg-blue-50' : 'hover:bg-gray-50'">
                                <td class="px-2 py-2 text-center">
                                    <input type="checkbox" :value="inv.id" @change="toggleInvoice(inv)" :checked="selectedInvoices.includes(inv.id)" :disabled="!selectedInvoices.includes(inv.id) && amount > 0 && amount <= disbursement" class="rounded border-gray-300">
                                </td>
                                <td class="px-2 py-2" x-text="inv.invoice_no"></td>
                                <td class="px-2 py-2" x-text="inv.invoice_date"></td>
                                <td class="px-2 py-2" x-text="inv.quality"></td>
                                <td class="px-2 py-2 text-right" x-text="inv.total_kg.toFixed(2)"></td>
                                <td class="px-2 py-2 text-right" x-text="'₹' + inv.rate_per_kg.toFixed(2)"></td>
                                <td class="px-2 py-2 text-right font-medium" x-text="'₹' + inv.net_rs.toFixed(2)"></td>
                                <td class="px-2 py-2 text-right text-green-600" x-text="'₹' + inv.total_paid.toFixed(2)"></td>
                                <td class="px-2 py-2 text-right font-semibold text-red-600" x-text="'₹' + inv.outstanding.toFixed(2)"></td>
                                <td class="px-2 py-2 text-right">
                                    <input type="number" x-show="selectedInvoices.includes(inv.id)" :value="invoicePayments[inv.id] || 0" @input="updateInvoicePayment(inv.id, $event.target.value)" step="0.01" class="w-20 px-1 py-1 text-xs border rounded text-right">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                    <tfoot class="bg-gray-50 font-semibold">
                        <tr>
                            <td colspan="9" class="px-2 py-2 text-right">Total Disbursement:</td>
                            <td class="px-2 py-2 text-right text-blue-600" x-text="'₹' + disbursement.toFixed(2)"></td>
                        </tr>
                    </tfoot>
                </table>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-2 pt-4 border-t">
                <div class="flex gap-2">
                    <button type="button" @click="previewPayment" class="px-3 py-1.5 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200">Preview</button>
                    <button type="button" x-show="paymentType === 'cheque'" @click="printCheque" class="px-3 py-1.5 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200">Print Cheque</button>
                </div>
                <div class="flex gap-2">
                    <a href="/payments" class="px-3 py-1.5 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200 inline-block">Exit</a>
                    <button type="submit" @click="validatePayment($event)" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Save Payment</button>
                </div>
            </div>
        </form>
        
        <!-- Bank Modal (Outside Form) -->
        <div x-show="showBankModal" x-effect="if(showBankModal) { bankErrors = {}; $nextTick(() => $refs.bankNameInput.focus()); }" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4" @click.away="showBankModal = false">
                <h3 class="text-lg font-semibold mb-4">Add Bank Account</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name *</label>
                        <input type="text" x-ref="bankNameInput" x-model="newBank.bank_name" @input="delete bankErrors.bank_name"
                               :class="bankErrors.bank_name ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="bankErrors.bank_name" x-text="bankErrors.bank_name" class="text-xs text-red-600 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Number *</label>
                        <input type="text" x-model="newBank.account_number" @input="delete bankErrors.account_number"
                               :class="bankErrors.account_number ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="bankErrors.account_number" x-text="bankErrors.account_number" class="text-xs text-red-600 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IFSC Code *</label>
                        <input type="text" x-model="newBank.ifsc_code" @input="delete bankErrors.ifsc_code"
                               :class="bankErrors.ifsc_code ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="bankErrors.ifsc_code" x-text="bankErrors.ifsc_code" class="text-xs text-red-600 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                        <input type="text" x-model="newBank.branch"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showBankModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="button" @click="addBank"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Add Bank
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Supplier Modal -->
        <div x-show="showSupplierModal" x-effect="if(showSupplierModal) { supplierErrors = {}; $nextTick(() => $refs.supplierNameInput.focus()); }" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4" @click.away="showSupplierModal = false">
                <h3 class="text-lg font-semibold mb-4">Add New Supplier</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supplier Name *</label>
                        <input type="text" x-ref="supplierNameInput" x-model="newSupplier.name" @input="delete supplierErrors.name"
                               :class="supplierErrors.name ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="supplierErrors.name" x-text="supplierErrors.name" class="text-xs text-red-600 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="text" x-model="newSupplier.phone" @input="delete supplierErrors.phone"
                               :class="supplierErrors.phone ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="supplierErrors.phone" x-text="supplierErrors.phone" class="text-xs text-red-600 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GSTIN</label>
                        <input type="text" x-model="newSupplier.gstin" @input="delete supplierErrors.gstin"
                               :class="supplierErrors.gstin ? 'border-red-500' : 'border-gray-300'"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span x-show="supplierErrors.gstin" x-text="supplierErrors.gstin" class="text-xs text-red-600 block"></span>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showSupplierModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                        <button type="button" @click="addSupplier"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Supplier</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function paymentForm() {
    return {
        invoices: [],
        selectedInvoices: [],
        invoicePayments: {},
        amount: 0,
        disbursement: 0,
        balanceAmount: 0,
        paymentType: 'cheque',
        showBankModal: false,
        showNoInvoiceModal: false,
        suppliers: {{ suppliers | tojson }},
        supplierId: '',
        supplierSearch: '',
        filteredSuppliers: [],
        showSupplierDropdown: false,
        supplierSelectedIndex: 0,
        showSupplierModal: false,
        newSupplier: { name: '', phone: '', gstin: '' },
        supplierErrors: {},
        banks: {{ banks | tojson }},
        bankSearch: '',
        filteredBanks: [],
        showBankDropdown: false,
        selectedBank: '',
        selectedBankId: '',
        bankSelectedIndex: 0,
        newBank: {
            bank_name: '',
            account_number: '',
            ifsc_code: '',
            branch: ''
        },
        bankErrors: {},
        
        init() {
            this.filteredBanks = this.banks;
            this.filteredSuppliers = [...this.suppliers];
            this.$nextTick(() => this.$refs.companyField.focus());
        },

        filterSuppliers() {
            const search = (this.supplierSearch || '').toLowerCase();
            this.filteredSuppliers = search
                ? this.suppliers.filter(s => s.name.toLowerCase().includes(search))
                : [...this.suppliers];
            this.supplierSelectedIndex = 0;
        },

        handleSupplierKeydown(e) {
            if (!this.showSupplierDropdown && (e.key === 'ArrowDown' || e.key === 'Enter')) {
                this.showSupplierDropdown = true;
                this.filterSuppliers();
                e.preventDefault();
                return;
            }
            if (!this.showSupplierDropdown) return;
            const maxIndex = this.filteredSuppliers.length;
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.supplierSelectedIndex = Math.min(this.supplierSelectedIndex + 1, maxIndex);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.supplierSelectedIndex = Math.max(this.supplierSelectedIndex - 1, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.supplierSelectedIndex < this.filteredSuppliers.length) {
                        this.selectSupplier(this.filteredSuppliers[this.supplierSelectedIndex]);
                    } else {
                        this.openSupplierModal();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    this.showSupplierDropdown = false;
                    break;
            }
        },

        selectSupplier(s) {
            this.supplierId = s._id;
            this.supplierSearch = s.name;
            this.showSupplierDropdown = false;
            this.checkSupplierInvoices();
        },

        openSupplierModal() {
            this.showSupplierModal = true;
            this.showSupplierDropdown = false;
        },

        async addSupplier() {
            this.supplierErrors = {};
            if (!this.newSupplier.name || !this.newSupplier.name.trim()) this.supplierErrors.name = 'Supplier name is required';
            if (this.newSupplier.phone && !/^\d{10}$/.test(this.newSupplier.phone.trim())) this.supplierErrors.phone = 'Mobile must be 10 digits';
            if (this.newSupplier.gstin && !/^\d{2}[A-Z]{5}\d{4}[A-Z][A-Z\d]Z[A-Z\d]$/i.test(this.newSupplier.gstin.trim())) this.supplierErrors.gstin = 'Invalid GSTIN format';
            if (Object.keys(this.supplierErrors).length > 0) return;

            try {
                const res = await fetch('/parties/api/quick-add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: this.newSupplier.name.trim(),
                        party_type: 'supplier',
                        phone: this.newSupplier.phone.trim(),
                        gstin: this.newSupplier.gstin.trim()
                    })
                });
                if (res.ok) {
                    const data = await res.json();
                    const supplier = { _id: data.id, name: data.name };
                    this.suppliers.push(supplier);
                    this.selectSupplier(supplier);
                    this.newSupplier = { name: '', phone: '', gstin: '' };
                    this.showSupplierModal = false;
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Failed to add supplier');
                }
            } catch (e) {
                alert('Error adding supplier');
            }
        },
        
        searchBanks() {
            const search = this.bankSearch.toLowerCase();
            this.filteredBanks = this.banks.filter(b => 
                b.bank_name.toLowerCase().includes(search) || b.account_number.toLowerCase().includes(search)
            );
            this.bankSelectedIndex = 0;
            this.showBankDropdown = true;
        },
        
        handleBankKeydown(e) {
            if (!this.showBankDropdown && (e.key === 'ArrowDown' || e.key === 'Enter')) {
                this.showBankDropdown = true;
                this.searchBanks();
                e.preventDefault();
                return;
            }
            if (!this.showBankDropdown) return;
            
            const maxIndex = this.filteredBanks.length;
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.bankSelectedIndex = Math.min(this.bankSelectedIndex + 1, maxIndex);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.bankSelectedIndex = Math.max(this.bankSelectedIndex - 1, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.bankSelectedIndex < this.filteredBanks.length) {
                        this.selectBank(this.filteredBanks[this.bankSelectedIndex]);
                    } else if (this.bankSelectedIndex === this.filteredBanks.length) {
                        this.openBankModal();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    this.showBankDropdown = false;
                    break;
            }
        },
        
        selectBank(bank) {
            this.selectedBank = bank.bank_name;
            this.selectedBankId = bank._id || '';
            this.bankSearch = bank.bank_name + ' - ' + bank.account_number;
            this.showBankDropdown = false;
            this.fetchChequeNo();
        },
        
        openBankModal() {
            console.log('openBankModal called');
            this.showBankModal = true;
            this.showBankDropdown = false;
            console.log('showBankModal is now:', this.showBankModal);
        },
        
        async checkSupplierInvoices() {
            const supplierId = this.supplierId;
            if (!supplierId) {
                this.invoices = [];
                return;
            }
            
            try {
                const response = await fetch(`/payments/api/supplier-invoices/${supplierId}`);
                this.invoices = await response.json();
                
                if (this.invoices.length === 0) {
                    if (confirm('No pending invoices for this supplier.\n\nWould you like to add a new purchase invoice?')) {
                        window.location.href = '/challans/create';
                    }
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        },
        
        togglePaymentFields() {
            if (this.paymentType === 'online') {
                document.getElementById('cheque_no').value = '';
            } else if (this.paymentType === 'cheque') {
                this.fetchChequeNo();
            }
        },

        async fetchChequeNo() {
            if (this.paymentType !== 'cheque' || !this.selectedBankId) return;
            try {
                var resp = await fetch('/banking/api/next-cheque?bank_id=' + this.selectedBankId);
                var data = await resp.json();
                if (data.next_cheque_no) {
                    document.getElementById('cheque_no').value = data.next_cheque_no;
                }
            } catch(e) {}
        },
        
        toggleInvoice(inv) {
            const idx = this.selectedInvoices.indexOf(inv.id);
            if (idx > -1) {
                this.selectedInvoices.splice(idx, 1);
                delete this.invoicePayments[inv.id];
            } else {
                this.selectedInvoices.push(inv.id);
                this.invoicePayments[inv.id] = 0;
            }
            this.distributePaymentOnChange();
        },
        
        distributePaymentOnChange() {
            if (this.amount > 0 && this.selectedInvoices.length > 0) {
                this.distributePayment();
            } else {
                this.calculateDisbursement();
            }
        },
        
        updateInvoicePayment(invId, value) {
            this.invoicePayments[invId] = parseFloat(value) || 0;
            this.calculateDisbursement();
        },
        
        calculateDisbursement() {
            this.disbursement = Object.values(this.invoicePayments).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            this.calculateBalance();
        },
        
        getSelectedInvoicesData() {
            return this.selectedInvoices.map(id => ({
                invoice_id: id,
                amount: this.invoicePayments[id] || 0
            }));
        },
        

        
        calculateBalance() {
            const amt = parseFloat(this.amount) || 0;
            const disb = parseFloat(this.disbursement) || 0;
            this.balanceAmount = amt - disb;
            
            if (this.balanceAmount < 0) {
                alert('Disbursement cannot exceed payment amount!');
                this.disbursement = amt;
                this.balanceAmount = 0;
            }
            
            this.calculateOutstanding();
        },
        

        
        async addBank() {
            this.bankErrors = {};
            if (!this.newBank.bank_name || !this.newBank.bank_name.trim()) this.bankErrors.bank_name = 'Bank Name is required';
            if (!this.newBank.account_number || !this.newBank.account_number.trim()) this.bankErrors.account_number = 'Account Number is required';
            if (!this.newBank.ifsc_code || !this.newBank.ifsc_code.trim()) this.bankErrors.ifsc_code = 'IFSC Code is required';
            else if (!/^[A-Z]{4}0[A-Z0-9]{6}$/i.test(this.newBank.ifsc_code.trim())) this.bankErrors.ifsc_code = 'Invalid IFSC format (e.g. SBIN0001234)';
            if (Object.keys(this.bankErrors).length > 0) return;
            
            try {
                const response = await fetch('/banking/api/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        account_name: this.newBank.bank_name,
                        account_number: this.newBank.account_number,
                        bank_name: this.newBank.bank_name,
                        branch: this.newBank.branch || '',
                        ifsc_code: this.newBank.ifsc_code,
                        account_type: 'Current',
                        opening_balance: 0
                    })
                });
                
                if (response.ok) {
                    const bank = {
                        bank_name: this.newBank.bank_name,
                        account_number: this.newBank.account_number,
                        ifsc_code: this.newBank.ifsc_code,
                        branch: this.newBank.branch
                    };
                    this.banks.push(bank);
                    this.selectBank(bank);
                    this.newBank = {bank_name: '', account_number: '', ifsc_code: '', branch: ''};
                    this.showBankModal = false;
                } else {
                    alert('Failed to add bank account');
                }
            } catch (error) {
                console.error('Error adding bank:', error);
                alert('Error adding bank account');
            }
        },
        
        previewPayment() {
            if (!this.selectedInvoice) {
                alert('Please select an invoice');
                return;
            }
            alert('Preview functionality - Show payment summary');
        },
        
        printCheque() {
            if (this.paymentType !== 'cheque') {
                alert('Print cheque is only available for cheque payments');
                return;
            }
            
            if (this.selectedInvoices.length === 0 || !this.disbursement) {
                alert('Please complete payment details');
                return;
            }
            
            const supplierName = document.getElementById('supplier_id').selectedOptions[0]?.text || '';
            const amountNum = parseFloat(this.disbursement) || 0;
            const invoiceNo = this.selectedInvoice.invoice_no;
            const paymentDate = document.getElementById('payment_date').value;
            const amountWords = this.numberToWords(amountNum);
            
            const printWindow = window.open('', '_blank');
            const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cheque Print</title>' +
                '<style>body{margin:0;padding:0;font-family:"Courier New",monospace}' +
                '.cheque{width:900px;margin:30px auto;border:1px solid #000;padding:40px}' +
                '.top-row{display:flex;justify-content:space-between;font-size:22px;font-weight:bold}' +
                '.payee{text-align:center;font-size:30px;font-weight:bold;margin-top:40px;margin-left:20px}' +
                '.amount-words{text-align:center;font-size:30px;margin-top:10px;margin-left:10px}' +
                '.rupees{display:flex;justify-content:space-between;margin-top:30px;font-size:20px}' +
                '.billno{margin-top:50px;font-size:20px;text-align:center}' +
                '@page{size:202mm 92mm;margin:0}' +
                '@media print{body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}.cheque{border:none;width:100%;padding:20px}}' +
                '</style></head><body><div class="cheque">' +
                '<div class="top-row"><div>A/C PAYEE</div><div>Transfer 3rd Day</div>' +
                '<div>' + paymentDate.split('-').reverse().join(' ') + '</div></div>' +
                '<div class="payee">' + supplierName.toUpperCase() + ' *****</div>' +
                '<div class="amount-words">' + amountWords + '</div>' +
                '<div class="rupees"><div>RUPEES ONLY ******</div>' +
                '<div>****' + amountNum.toFixed(2) + '</div></div>' +
                '<div class="billno">Bill No. ' + invoiceNo + '</div>' +
                '</div><script>setTimeout(()=>window.print(),500);<\/script></body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
        },
        
        numberToWords(num) {
            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
            const teens = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
            
            if (num === 0) return 'ZERO';
            
            let n = Math.floor(num);
            let words = '';
            
            if (n >= 100000) {
                words += ones[Math.floor(n / 100000)] + ' LAKH ';
                n %= 100000;
            }
            if (n >= 1000) {
                const thousands = Math.floor(n / 1000);
                if (thousands >= 10) {
                    words += tens[Math.floor(thousands / 10)] + ' ';
                    if (thousands % 10 > 0) words += ones[thousands % 10] + ' ';
                } else {
                    words += ones[thousands] + ' ';
                }
                words += 'THOUSAND ';
                n %= 1000;
            }
            if (n >= 100) {
                words += ones[Math.floor(n / 100)] + ' HUNDRED ';
                n %= 100;
            }
            if (n >= 20) {
                words += tens[Math.floor(n / 10)] + ' ';
                n %= 10;
            } else if (n >= 10) {
                words += teens[n - 10] + ' ';
                n = 0;
            }
            if (n > 0) {
                words += ones[n] + ' ';
            }
            
            return words.trim();
        },
        
        validatePayment(event) {
            const amt = parseFloat(this.amount) || 0;
            const disb = parseFloat(this.disbursement) || 0;
            
            if (this.selectedInvoices.length === 0) {
                event.preventDefault();
                alert('Please select at least one invoice');
                return false;
            }
            
            if (amt <= 0) {
                event.preventDefault();
                alert('Please enter a valid payment amount');
                return false;
            }
            
            if (this.paymentType === 'cheque' && !document.getElementById('cheque_no').value.trim()) {
                event.preventDefault();
                alert('Cheque number is required for cheque payments');
                document.getElementById('cheque_no').focus();
                return false;
            }
            
            if (amt > disb) {
                event.preventDefault();
                document.getElementById('amount').focus();
                return false;
            }
            
            this.distributePayment();
            return true;
        },
        
        distributePayment() {
            let remainingAmount = parseFloat(this.amount) || 0;
            
            for (let i = 0; i < this.selectedInvoices.length; i++) {
                const invId = this.selectedInvoices[i];
                const invoice = this.invoices.find(inv => inv.id === invId);
                
                if (invoice) {
                    if (remainingAmount >= invoice.outstanding) {
                        this.invoicePayments[invId] = invoice.outstanding;
                        remainingAmount -= invoice.outstanding;
                    } else {
                        this.invoicePayments[invId] = remainingAmount;
                        remainingAmount = 0;
                        break;
                    }
                }
            }
            
            this.calculateDisbursement();
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payment_date').value = today;
});
</script>
{% endblock %}