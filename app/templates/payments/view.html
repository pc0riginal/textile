{% extends "base.html" %}

{% block title %}Payment Details - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Payment Details</h1>
            <p class="text-gray-600">{{ payment.payment_no }}</p>
        </div>
        <div class="flex gap-2">
            {% if payment.payment_type != 'online' %}
            <button onclick="printCheque()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Print Cheque
            </button>
            {% endif %}
            <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                Print Details
            </button>
            <form method="POST" action="/payments/{{ payment._id }}/delete" class="inline" onsubmit="return confirm('Delete this payment?')">
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Delete
                </button>
            </form>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label class="text-xs font-medium text-gray-500">Payment No</label>
                <p class="text-sm font-semibold text-gray-900">{{ payment.payment_no }}</p>
            </div>
            <div>
                <label class="text-xs font-medium text-gray-500">Date</label>
                <p class="text-sm font-semibold text-gray-900">{{ payment.payment_date.strftime('%d-%m-%Y') }}</p>
            </div>
            <div>
                <label class="text-xs font-medium text-gray-500">{{ 'Customer' if payment.payment_type == 'receipt' else 'Supplier' }}</label>
                <p class="text-sm font-semibold text-gray-900">{{ payment.party_name or payment.supplier_name }}</p>
            </div>
            <div>
                <label class="text-xs font-medium text-gray-500">Invoices</label>
                <p class="text-sm font-semibold text-gray-900">{{ payment.invoices|length if payment.invoices else 1 }}</p>
            </div>
        </div>

        <div class="border-t pt-4">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Payment Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">{{ 'Cheque Amount' if payment.payment_type == 'receipt' else 'Amount' }}</label>
                    <p class="text-sm font-semibold text-gray-900">₹{{ "{:,.2f}".format(payment.cheque_amount or payment.amount or 0) }}</p>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">Disbursement</label>
                    <p class="text-sm font-semibold text-green-600">₹{{ "{:,.2f}".format(payment.amount_disburse or payment.disbursement or 0) }}</p>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">Balance</label>
                    <p class="text-sm font-semibold text-gray-900">₹{{ "{:,.2f}".format(payment.balance_amount or 0) }}</p>
                </div>
            </div>
        </div>

        {% if payment.invoices %}
        <div class="border-t pt-4">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Invoice Details</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left font-medium text-gray-700">Invoice No</th>
                            <th class="px-4 py-2 text-left font-medium text-gray-700">Challan No</th>
                            <th class="px-4 py-2 text-right font-medium text-gray-700">Amount Paid</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for inv in payment.invoices %}
                        <tr>
                            <td class="px-4 py-2">{{ inv.invoice_no }}</td>
                            <td class="px-4 py-2">{{ inv.challan_no or '-' }}</td>
                            <td class="px-4 py-2 text-right font-semibold">₹{{ "{:,.2f}".format(inv.amount) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if payment.bank_name or payment.cheque_no %}
        <div class="border-t pt-4">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Bank Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% if payment.bank_name %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Bank Name</label>
                    <p class="text-sm font-semibold text-gray-900">{{ payment.bank_name }}</p>
                </div>
                {% endif %}
                {% if payment.cheque_no %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Cheque/Online No</label>
                    <p class="text-sm font-semibold text-gray-900">{{ payment.cheque_no }}</p>
                </div>
                {% endif %}
                {% if payment.cheque_amount %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Cheque Amount</label>
                    <p class="text-sm font-semibold text-gray-900">₹{{ "{:,.2f}".format(payment.cheque_amount) }}</p>
                </div>
                {% endif %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Passbook Effect</label>
                    <p class="text-sm font-semibold text-gray-900">{{ "Yes" if payment.effect_on_passbook else "No" }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if payment.kasar or payment.interest or payment.rr %}
        <div class="border-t pt-4">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Additional Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% if payment.kasar %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Kasar</label>
                    <p class="text-sm font-semibold text-gray-900">₹{{ "{:,.2f}".format(payment.kasar) }}</p>
                </div>
                {% endif %}
                {% if payment.interest %}
                <div>
                    <label class="text-xs font-medium text-gray-500">Interest</label>
                    <p class="text-sm font-semibold text-gray-900">₹{{ "{:,.2f}".format(payment.interest) }}</p>
                </div>
                {% endif %}
                {% if payment.rr %}
                <div>
                    <label class="text-xs font-medium text-gray-500">RR</label>
                    <p class="text-sm font-semibold text-gray-900">{{ payment.rr }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="flex justify-between">
        <a href="/payments" class="px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200">
            Back to Payments
        </a>
        <a href="/payments/receipt/create" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            New Payment
        </a>
    </div>
</div>

<style>
@media print {
    .no-print, button, a[href*="edit"], a[href*="delete"], form {
        display: none !important;
    }
    body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function printCheque() {
    {% if payment.payment_type == 'online' %}
    alert('Print cheque is not available for online payments');
    return;
    {% endif %}
    
    const supplierName = '{{ payment.party_name or payment.supplier_name }}';
    const amount = parseFloat({{ payment.cheque_amount or payment.amount or 0 }});
    const invoiceNo = '{% if payment.invoices %}{% for inv in payment.invoices %}{{ inv.invoice_no }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}{{ payment.invoice_no|default("") }}{% endif %}';
    const paymentDate = '{{ payment.payment_date.strftime("%Y-%m-%d") }}';
    
    const amountWords = numberToWords(amount);
    const formattedDate = formatDateForCheque(paymentDate);
    const formattedAmount = formatIndianNumber(amount);
    
    const printWindow = window.open('', '_blank');
    const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cheque Print</title>' +
        '<style>*{margin:0;padding:0;box-sizing:border-box}' +
        'body{font-family:Arial,sans-serif;padding:0;background:white;margin:0}' +
        '.cheque-container{width:202mm;height:92mm;margin:0 auto;background:white;position:relative}' +
        '.ac-payee{position:absolute;top:12mm;left:80mm;font-size:10px;font-weight:bold;border:2px solid #000;padding:2px 6px}' +
        '.cheque-date{position:absolute;top:11mm;right:10mm;font-size:16px;font-weight:bold;letter-spacing:2.7mm;font-family:"Courier New",monospace}' +
        '.payee-name{position:absolute;top:23mm;font-size:20px;font-weight:bold;max-width:150mm;line-height:1.3}' +
        '.amount-words{text-wrap:auto;position:absolute;top:35mm;left:10mm;font-size:17px;font-weight:600;max-width:130mm;line-height:1.4;text-transform:capitalize}' +
        '.amount-figures{position:absolute;top:40mm;left:20mm;right:10mm;font-size:16px;font-weight:bold;font-family:"Courier New",monospace;padding:2mm 3mm;min-width:40mm;text-align:right;color:#000}' +
        '.bill-number{position:absolute;bottom:10mm;left:40%;transform:translateX(-50%);font-size:11px}' +
        '@media print{body{margin:0;padding:0}@page{size:202mm 92mm;margin:0}.cheque-container{page-break-after:always;margin:0}}' +
        '</style></head><body>' +
        '<div class="cheque-container">' +
        '<div class="ac-payee">A/C PAYEE</div>' +
        '<div class="cheque-date">' + formattedDate + '</div>' +
        '<div class="payee-name">**' + supplierName + '**</div>' +
        '<div class="amount-words">**' + amountWords + ' Only**</div>' +
        '<div class="amount-figures">**' + formattedAmount + '**</div>' +
        '<div class="bill-number">Bill No: ' + invoiceNo + '</div>' +
        '</div>' +
        '<script>setTimeout(()=>window.print(),500);<\/script>' +
        '</body></html>';
    
    printWindow.document.write(html);
    printWindow.document.close();
}

function formatDateForCheque(dateStr) {
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = String(date.getFullYear());
    return (day + month + year).split('').join('');
}

function formatIndianNumber(num) {
    const [integer, decimal] = num.toFixed(2).split('.');
    let lastThree = integer.substring(integer.length - 3);
    let otherNumbers = integer.substring(0, integer.length - 3);
    if (otherNumbers !== '') {
        lastThree = ',' + lastThree;
    }
    return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree + '.' + decimal;
}

function numberToWords(num) {
    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    
    if (num === 0) return 'Zero';
    
    function convertHundreds(n) {
        let str = '';
        if (n > 99) {
            str += ones[Math.floor(n / 100)] + ' Hundred ';
            n %= 100;
            if (n > 0) str += 'And ';
        }
        if (n > 19) {
            str += tens[Math.floor(n / 10)] + ' ';
            n %= 10;
        }
        if (n > 9) {
            str += teens[n - 10] + ' ';
            return str;
        }
        if (n > 0) {
            str += ones[n] + ' ';
        }
        return str;
    }
    
    let n = Math.floor(num);
    let crores = Math.floor(n / 10000000);
    n %= 10000000;
    let lakhs = Math.floor(n / 100000);
    n %= 100000;
    let thousands = Math.floor(n / 1000);
    n %= 1000;
    let remainder = n;
    
    let result = '';
    if (crores > 0) result += convertHundreds(crores) + 'Crore ';
    if (lakhs > 0) result += convertHundreds(lakhs) + 'Lakh ';
    if (thousands > 0) result += convertHundreds(thousands) + 'Thousand ';
    if (remainder > 0) result += convertHundreds(remainder);
    
    return result.trim();
}
</script>
{% endblock %}
