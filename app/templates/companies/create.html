{% extends "base.html" %}

{% block title %}Create Company - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-4 md:space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Create New Company</h1>
        <p class="text-sm text-gray-600">Add a new business entity to your account</p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6">
        {% if error %}
        <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
            {{ error }}
        </div>
        {% endif %}

        <form method="POST" action="/companies/create" class="space-y-6" onsubmit="return validateForm()">
            <!-- GST Auto-fill Section -->
            <div id="gst-autofill-section" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="text-sm font-semibold text-blue-800">Quick Fill with GST Number</h3>
                </div>
                <p class="text-xs text-blue-700 mb-3">Enter your company's GST number to auto-fill name, PAN, address, and other details from the GST portal.</p>
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input type="text" id="gst-quick-input" maxlength="15" 
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 uppercase font-mono" 
                               placeholder="Enter 15-digit GSTIN"
                               oninput="this.value = this.value.toUpperCase(); updateQuickGSTBtn();"
                               onpaste="setTimeout(() => { this.value = this.value.toUpperCase(); updateQuickGSTBtn(); }, 0);">
                    </div>
                    <button type="button" id="gst-quick-btn" onclick="quickVerifyGST()" disabled
                        class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Verify & Auto-fill
                    </button>
                </div>
                <p id="gst-quick-error" class="text-xs text-red-600 mt-1 hidden"></p>
                <p class="text-xs text-blue-600 mt-1">Or skip this and fill the form manually below.</p>
            </div>

            <!-- GST Verified Banner -->
            <div id="gst-verified-banner" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-sm font-semibold text-green-800">GST Verified</span>
                        <span id="gst-verified-gstin" class="text-xs text-green-700 font-mono"></span>
                    </div>
                    <button type="button" onclick="resetGSTVerification()" class="text-xs text-green-700 hover:text-green-900 underline">Change</button>
                </div>
                <p id="gst-verified-name" class="text-xs text-green-700 mt-1"></p>
            </div>

            <!-- Basic Information -->
            <div>
                <h3 class="text-base md:text-lg font-medium text-gray-900 mb-3 md:mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                        <input type="text" id="name" name="name" required autofocus
                               oninput="validateCompanyField('name')" onblur="validateCompanyField('name')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <span id="name-error" class="text-xs text-red-600 hidden"></span>
                    </div>
                    
                    <div>
                        <label for="gstin" class="block text-sm font-medium text-gray-700 mb-2">GSTIN *</label>
                        <div class="relative">
                            <input type="text" id="gstin" name="gstin" maxlength="15" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase font-mono"
                                   placeholder="22AAAAA0000A1Z5" oninput="this.value = this.value.toUpperCase(); validateCompanyField('gstin');" onblur="validateCompanyField('gstin')">
                            <div id="gstin-check" class="absolute right-2 top-1/2 -translate-y-1/2 text-green-500 hidden">✓</div>
                        </div>
                        <span id="gstin-error" class="text-xs text-red-600 hidden"></span>
                        <span id="gstin-info" class="text-xs text-green-600 hidden"></span>
                        <span id="gstin-verify-link" class="hidden">
                            <button type="button" onclick="verifyGSTFromField()" class="text-xs text-blue-600 hover:text-blue-800 underline mt-1">Verify & Auto-fill from GST portal</button>
                        </span>
                    </div>
                    
                    <div>
                        <label for="pan" class="block text-sm font-medium text-gray-700 mb-2">PAN</label>
                        <input type="text" id="pan" name="pan" maxlength="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase font-mono"
                               placeholder="AAAAA0000A" oninput="this.value = this.value.toUpperCase(); validateCompanyField('pan')">
                        <span id="pan-error" class="text-xs text-red-600 hidden"></span>
                    </div>
                    
                    <div>
                        <label for="financial_year" class="block text-sm font-medium text-gray-700 mb-2">Financial Year *</label>
                        <input type="text" id="financial_year" name="financial_year" required
                               oninput="validateCompanyField('financial_year')" onblur="validateCompanyField('financial_year')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="YYYY-YYYY">
                        <span id="financial_year-error" class="text-xs text-red-600 hidden"></span>
                        <p class="text-xs text-gray-500 mt-1">Format: YYYY-YYYY (e.g., 2024-2025)</p>
                    </div>
                </div>
            </div>

            <!-- Address -->
            <div>
                <h3 class="text-base md:text-lg font-medium text-gray-900 mb-3 md:mb-4">Address</h3>
                <div class="space-y-4">
                    <div>
                        <label for="address_line1" class="block text-sm font-medium text-gray-700 mb-2">Address Line 1 *</label>
                        <input type="text" id="address_line1" name="address_line1" required
                               oninput="validateCompanyField('address_line1')" onblur="validateCompanyField('address_line1')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <span id="address_line1-error" class="text-xs text-red-600 hidden"></span>
                    </div>
                    
                    <div>
                        <label for="address_line2" class="block text-sm font-medium text-gray-700 mb-2">Address Line 2</label>
                        <input type="text" id="address_line2" name="address_line2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
                            <input type="text" id="city" name="city"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <input type="text" id="state" name="state"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label for="pincode" class="block text-sm font-medium text-gray-700 mb-2">Pincode</label>
                            <input type="text" id="pincode" name="pincode" maxlength="6"
                                   oninput="validateCompanyField('pincode')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span id="pincode-error" class="text-xs text-red-600 hidden"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div>
                <h3 class="text-base md:text-lg font-medium text-gray-900 mb-3 md:mb-4">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                        <input type="tel" id="phone" name="phone" required maxlength="10"
                               oninput="validateCompanyField('phone')" onblur="validateCompanyField('phone')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <span id="phone-error" class="text-xs text-red-600 hidden"></span>
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" name="email"
                               oninput="validateCompanyField('email')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <span id="email-error" class="text-xs text-red-600 hidden"></span>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="website" class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                        <input type="url" id="website" name="website"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="https://www.example.com">
                    </div>
                </div>
            </div>

            <!-- Document Series -->
            <div>
                <h3 class="text-base md:text-lg font-medium text-gray-900 mb-3 md:mb-4">Document Series</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <label for="invoice_series" class="block text-sm font-medium text-gray-700 mb-2">Invoice Series</label>
                        <input type="text" id="invoice_series" name="invoice_series" value="INV"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Invoices will be numbered as INV0001, INV0002, etc.</p>
                    </div>
                    
                    <div>
                        <label for="challan_series" class="block text-sm font-medium text-gray-700 mb-2">Challan Series</label>
                        <input type="text" id="challan_series" name="challan_series" value="CH"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Challans will be numbered as CH0001, CH0002, etc.</p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 sm:gap-4 pt-4 md:pt-6 border-t border-gray-200">
                <a href="/companies" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 text-center text-sm">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                    Create Company
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Track GST verification state
let companyGSTVerified = false;

// Set current financial year on page load
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const month = today.getMonth() + 1;
    const year = today.getFullYear();
    let fyStart, fyEnd;
    if (month >= 4) { fyStart = year; fyEnd = year + 1; }
    else { fyStart = year - 1; fyEnd = year; }
    document.getElementById('financial_year').value = fyStart + '-' + fyEnd;
});

function validateCompanyField(id) {
    const val = document.getElementById(id).value.trim();
    clearError(id);
    if (id === 'name') {
        if (!val) { showError(id, 'Company name is required'); return false; }
        if (/^\d+$/.test(val)) { showError(id, 'Company name must contain letters'); return false; }
    }
    if (id === 'gstin') {
        if (!val) { showError(id, 'GSTIN is required'); return false; }
        if (val.length !== 15) { showError(id, 'GSTIN must be exactly 15 characters'); return false; }
        if (!/^\d{2}[A-Z]{5}\d{4}[A-Z]\d[Z][A-Z\d]$/.test(val)) { showError(id, 'Invalid GSTIN format (e.g. 22AAAAA0000A1Z5)'); return false; }
        // Show verify link if not yet verified
        const verifyLink = document.getElementById('gstin-verify-link');
        if (!companyGSTVerified && val.length === 15) {
            verifyLink.classList.remove('hidden');
        } else {
            verifyLink.classList.add('hidden');
        }
    }
    if (id === 'pan' && val) {
        if (val.length !== 10) { showError(id, 'PAN must be exactly 10 characters'); return false; }
        if (!/^[A-Z]{5}\d{4}[A-Z]{1}$/.test(val)) { showError(id, 'Invalid PAN format (e.g. AAAAA0000A)'); return false; }
    }
    if (id === 'financial_year') {
        if (!val) { showError(id, 'Financial year is required'); return false; }
        if (!/^\d{4}-\d{4}$/.test(val)) { showError(id, 'Format must be YYYY-YYYY'); return false; }
        const [s, e] = val.split('-').map(Number);
        if (e !== s + 1) { showError(id, 'End year must be start year + 1'); return false; }
    }
    if (id === 'address_line1' && !val) { showError(id, 'Address line 1 is required'); return false; }
    if (id === 'pincode' && val && !/^[0-9]{6}$/.test(val)) { showError(id, 'Pincode must be exactly 6 digits'); return false; }
    if (id === 'phone') {
        if (!val) { showError(id, 'Phone is required'); return false; }
        if (!/^[0-9]{10}$/.test(val)) { showError(id, 'Phone must be exactly 10 digits'); return false; }
    }
    if (id === 'email' && val && !/^[\w\.-]+@[\w\.-]+\.\w+$/.test(val)) { showError(id, 'Invalid email format'); return false; }
    return true;
}

function validateForm() {
    let isValid = true;
    let firstError = null;
    const fields = ['name','gstin','pan','financial_year','address_line1','pincode','phone','email'];
    fields.forEach(f => {
        if (!validateCompanyField(f)) { isValid = false; if (!firstError) firstError = document.getElementById(f); }
    });
    if (!isValid && firstError) { firstError.focus(); firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    return isValid;
}

function showError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(fieldId + '-error');
    field.classList.add('border-red-500');
    error.textContent = message;
    error.classList.remove('hidden');
}

function clearError(fieldId) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(fieldId + '-error');
    if (field) field.classList.remove('border-red-500');
    if (error) { error.textContent = ''; error.classList.add('hidden'); }
}

// Quick GST input validation for the top section
function updateQuickGSTBtn() {
    const input = document.getElementById('gst-quick-input');
    const btn = document.getElementById('gst-quick-btn');
    const error = document.getElementById('gst-quick-error');
    const val = input.value.trim();
    error.classList.add('hidden');
    
    if (val.length === 15) {
        if (!/^\d{2}[A-Z]{5}\d{4}[A-Z]\d[Z][A-Z\d]$/.test(val)) {
            error.textContent = 'Invalid GSTIN format';
            error.classList.remove('hidden');
            btn.disabled = true;
        } else {
            btn.disabled = false;
        }
    } else {
        btn.disabled = true;
    }
}

// Quick verify from the top section
function quickVerifyGST() {
    const gstin = document.getElementById('gst-quick-input').value.trim().toUpperCase();
    if (!gstin || gstin.length !== 15) return;
    
    // Copy GSTIN to the actual form field
    document.getElementById('gstin').value = gstin;
    
    // Trigger verification
    doGSTVerification(gstin);
}

// Verify from the GSTIN field's inline link
function verifyGSTFromField() {
    const gstin = document.getElementById('gstin').value.trim().toUpperCase();
    if (!gstin || gstin.length !== 15) return;
    doGSTVerification(gstin);
}

// Shared GST verification logic
function doGSTVerification(gstin) {
    if (typeof GSTVerification === 'undefined') {
        console.error('GSTVerification not loaded');
        return;
    }
    
    const gstVerification = new GSTVerification();
    
    gstVerification.showVerificationModal(gstin, (data) => {
        // Auto-fill company name
        const nameField = document.getElementById('name');
        if (nameField && !nameField.value.trim() && (data.trade_name || data.legal_name)) {
            nameField.value = data.trade_name || data.legal_name;
        }
        
        // Extract PAN from GSTIN (characters 3-12)
        const panField = document.getElementById('pan');
        if (panField && !panField.value.trim()) {
            panField.value = gstin.substring(2, 12);
        }
        
        // Auto-fill GSTIN field
        document.getElementById('gstin').value = gstin;
        
        // Auto-fill address
        const addr1 = document.getElementById('address_line1');
        if (addr1 && !addr1.value.trim() && data.address) {
            addr1.value = data.address;
        }
        
        const cityField = document.getElementById('city');
        if (cityField && !cityField.value.trim() && data.city) {
            cityField.value = data.city;
        }
        
        const stateField = document.getElementById('state');
        if (stateField && !stateField.value.trim() && data.state) {
            stateField.value = data.state;
        }
        
        const pincodeField = document.getElementById('pincode');
        if (pincodeField && !pincodeField.value.trim() && data.pincode) {
            pincodeField.value = data.pincode;
        }
        
        // Update UI state
        companyGSTVerified = true;
        
        // Show verified banner, hide auto-fill section
        document.getElementById('gst-autofill-section').classList.add('hidden');
        const banner = document.getElementById('gst-verified-banner');
        banner.classList.remove('hidden');
        document.getElementById('gst-verified-gstin').textContent = gstin;
        document.getElementById('gst-verified-name').textContent = '✓ ' + (data.legal_name || data.trade_name);
        
        // Show checkmark on GSTIN field
        document.getElementById('gstin-check').classList.remove('hidden');
        const info = document.getElementById('gstin-info');
        info.textContent = '✓ ' + (data.legal_name || data.trade_name);
        info.classList.remove('hidden');
        document.getElementById('gstin-verify-link').classList.add('hidden');
        
        // Highlight auto-filled fields briefly
        document.getElementById('gstin').classList.add('border-green-400', 'bg-green-50');
        if (panField.value) panField.classList.add('border-green-400', 'bg-green-50');
        
        if (typeof showToast === 'function') {
            showToast('GST details verified and auto-filled successfully', 'success');
        }
    });
}

// Reset GST verification state
function resetGSTVerification() {
    companyGSTVerified = false;
    document.getElementById('gst-autofill-section').classList.remove('hidden');
    document.getElementById('gst-verified-banner').classList.add('hidden');
    document.getElementById('gstin-check').classList.add('hidden');
    document.getElementById('gstin-info').classList.add('hidden');
    document.getElementById('gstin').classList.remove('border-green-400', 'bg-green-50');
    document.getElementById('pan').classList.remove('border-green-400', 'bg-green-50');
    document.getElementById('gst-quick-input').value = '';
    document.getElementById('gst-quick-input').focus();
}
</script>

<!-- GST Verification Script -->
<script src="/static/js/gst-verification.js"></script>

{% endblock %}