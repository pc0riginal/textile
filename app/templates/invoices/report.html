{% extends "base.html" %}

{% block title %}Sales Report - Textile ERP{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Sales Report</h1>
            <p class="text-gray-600">Comprehensive sales analysis and summary</p>
        </div>
        <div class="flex gap-2">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Print
            </button>
            <a href="/invoices" class="bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200">Back</a>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6">
        <h2 class="text-lg font-semibold mb-4">Filter Options</h2>
        <form method="GET" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" name="start_date" value="{{ start_date or '' }}" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" name="end_date" value="{{ end_date or '' }}" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
                    <select name="customer_id" class="w-full px-3 py-2 border rounded-md">
                        <option value="">All Customers</option>
                        {% for customer in customers %}
                        <option value="{{ customer._id }}" {% if customer_id and customer_id == customer._id|string %}selected{% endif %}>{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
                    <select name="broker_id" class="w-full px-3 py-2 border rounded-md">
                        <option value="">All Brokers</option>
                        {% for broker in brokers %}
                        <option value="{{ broker._id }}" {% if broker_id and broker_id == broker._id|string %}selected{% endif %}>{{ broker.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quality</label>
                    <select name="quality" class="w-full px-3 py-2 border rounded-md">
                        <option value="">All Qualities</option>
                        {% for q in qualities %}
                        <option value="{{ q.name }}" {% if quality == q.name %}selected{% endif %}>{{ q.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <select name="payment_filter" class="w-full px-3 py-2 border rounded-md">
                        <option value="all" {% if not payment_filter or payment_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="dues" {% if payment_filter == 'dues' %}selected{% endif %}>Pending/Partial</option>
                        <option value="paid" {% if payment_filter == 'paid' %}selected{% endif %}>Fully Paid</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="w-full md:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Apply Filters</button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Invoices</h3>
            <p class="text-3xl font-bold mt-2">{{ invoices|length }}</p>
        </div>
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Sales</h3>
            <p class="text-3xl font-bold mt-2">₹{{ "{:,.2f}".format(total_sales) }}</p>
        </div>
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Paid</h3>
            <p class="text-3xl font-bold mt-2">₹{{ "{:,.2f}".format(total_paid) }}</p>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Pending</h3>
            <p class="text-3xl font-bold mt-2">₹{{ "{:,.2f}".format(total_pending) }}</p>
        </div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Interest</h3>
            <p class="text-3xl font-bold mt-2">₹{{ "{:,.2f}".format(total_interest or 0) }}</p>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-sm font-medium opacity-90">Total Outstanding</h3>
            <p class="text-3xl font-bold mt-2">₹{{ "{:,.2f}".format(total_outstanding or 0) }}</p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border">
        <div class="p-4 border-b bg-gray-50">
            <h2 class="text-lg font-semibold">Invoice Details</h2>
        </div>
        {% if invoices %}
        <!-- Mobile View -->
        <div class="md:hidden divide-y">
            {% for invoice in invoices %}
            <div class="p-4 space-y-3">
                <div class="flex justify-between items-start">
                    <div>
                        <a href="/invoices/{{ invoice._id }}" class="text-sm font-semibold text-blue-600">{{ invoice.invoice_no }}</a>
                        <p class="text-xs text-gray-500">{{ invoice.invoice_date.strftime('%d-%m-%Y') }}</p>
                    </div>
                    <span class="px-2 py-1 text-xs rounded {% if invoice.payment_status == 'paid' %}bg-green-100 text-green-700{% elif invoice.payment_status == 'partial' %}bg-yellow-100 text-yellow-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {{ invoice.payment_status|title }}
                    </span>
                </div>
                <div class="text-xs space-y-1">
                    <div><span class="text-gray-600">Customer:</span> <span class="font-medium">{{ invoice.customer_name }}</span></div>
                    <div><span class="text-gray-600">Broker:</span> {{ invoice.get('broker_name', '-') }}</div>
                </div>
                {% for item in invoice.get('items', []) %}
                <div class="bg-gray-50 p-2 rounded text-xs space-y-1">
                    <div class="font-medium">{{ item.get('quality', '-') }}</div>
                    <div class="grid grid-cols-2 gap-1">
                        <div><span class="text-gray-600">Taka:</span> {{ item.get('total_taka', 0)|int }}</div>
                        <div><span class="text-gray-600">Meters:</span> {{ "%.2f"|format(item.get('meters', 0)) }}</div>
                        <div><span class="text-gray-600">Rate:</span> ₹{{ "%.2f"|format(item.get('rate_per_meter', 0)) }}</div>
                        <div><span class="text-gray-600">Amount:</span> ₹{{ "%.2f"|format(item.get('taxable_amount', 0)) }}</div>
                    </div>
                </div>
                {% endfor %}
                <div class="border-t pt-2 space-y-1 text-xs">
                    <div class="flex justify-between"><span class="text-gray-600">Total:</span> <span class="font-semibold">₹{{ "{:,.2f}".format(invoice.total_amount) }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Paid:</span> <span class="text-green-600">₹{{ "{:,.2f}".format(invoice.get('total_paid', invoice.get('paid_amount', 0))) }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Balance:</span> <span class="{% if invoice.balance_amount > 0 %}text-red-600{% else %}text-green-600{% endif %} font-semibold">₹{{ "{:,.2f}".format(invoice.balance_amount or invoice.total_amount) }}</span></div>
                </div>
            </div>
            {% endfor %}
            <div class="p-4 bg-gray-100 border-t-2 space-y-2 text-sm font-semibold">
                <div class="text-center text-gray-700 mb-2">Grand Total</div>
                <div class="flex justify-between"><span>Total:</span> <span>₹{{ "{:,.2f}".format(total_sales) }}</span></div>
                <div class="flex justify-between text-green-600"><span>Paid:</span> <span>₹{{ "{:,.2f}".format(total_paid) }}</span></div>
                <div class="flex justify-between text-red-600"><span>Pending:</span> <span>₹{{ "{:,.2f}".format(total_pending) }}</span></div>
            </div>
        </div>
        <!-- Desktop View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 border-b border-gray-200">
                    <tr>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-700 whitespace-nowrap">Date</th>
                        <th class="px-1 py-2 text-left text-xs font-medium text-gray-700">Invoice No</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Customer</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Broker</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700">Due Days</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Quality</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Taka</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Meters</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Rate</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Amount</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Taxable</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">GST</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Total</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Paid</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Interest</th>
                        <th class="px-2 py-2 text-right text-xs font-medium text-gray-700">Outstanding</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                        {% set item_count = invoice.get('items', []) | length %}
                        {% for item in invoice.get('items', []) %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            {% if loop.first %}
                            <td class="px-2 py-2 text-xs whitespace-nowrap" rowspan="{{ item_count }}">{{ invoice.invoice_date.strftime('%d-%m-%Y') }}</td>
                            <td class="px-1 py-2 text-xs font-medium text-blue-600" rowspan="{{ item_count }}">
                                <a href="/invoices/{{ invoice._id }}" class="hover:underline">{{ invoice.invoice_no }}</a>
                            </td>
                            <td class="px-2 py-2 text-xs" rowspan="{{ item_count }}">{{ invoice.customer_name }}</td>
                            <td class="px-2 py-2 text-xs" rowspan="{{ item_count }}">{{ invoice.get('broker_name', '-') }}</td>
                            <td class="px-2 py-2 text-xs text-center" rowspan="{{ item_count }}">{{ invoice.get('due_days', 0) }}</td>
                            {% endif %}
                            <td class="px-2 py-2 text-xs">{{ item.get('quality', '-') }}</td>
                            <td class="px-2 py-2 text-xs text-right">{{ item.get('total_taka', 0)|int }}</td>
                            <td class="px-2 py-2 text-xs text-right">{{ "%.2f"|format(item.get('meters', 0)) }}</td>
                            <td class="px-2 py-2 text-xs text-right">₹{{ "%.2f"|format(item.get('rate_per_meter', 0)) }}</td>
                            <td class="px-2 py-2 text-xs text-right">₹{{ "%.2f"|format(item.get('taxable_amount', 0)) }}</td>
                            {% if loop.first %}
                            <td class="px-2 py-2 text-xs text-right" rowspan="{{ item_count }}">₹{{ "{:,.2f}".format(invoice.get('items', [])|sum(attribute='taxable_amount')) }}</td>
                            <td class="px-2 py-2 text-xs text-right" rowspan="{{ item_count }}">₹{{ "{:,.2f}".format(invoice.get('items', [])|sum(attribute='cgst') + invoice.get('items', [])|sum(attribute='sgst') + invoice.get('items', [])|sum(attribute='igst')) }}</td>
                            <td class="px-2 py-2 text-xs text-right font-semibold" rowspan="{{ item_count }}">₹{{ "{:,.2f}".format(invoice.total_amount) }}</td>
                            <td class="px-2 py-2 text-xs text-right text-green-600" rowspan="{{ item_count }}">₹{{ "{:,.2f}".format(invoice.get('total_paid', invoice.get('paid_amount', 0))) }}</td>
                            <td class="px-2 py-2 text-xs text-right text-orange-600" rowspan="{{ item_count }}">
                                {% if invoice.get('interest_amount', 0) > 0 %}
                                ₹{{ "{:,.2f}".format(invoice.interest_amount) }}
                                <span class="text-gray-500">({{ invoice.get('overdue_days', 0) }}d)</span>
                                {% else %}-{% endif %}
                            </td>
                            <td class="px-2 py-2 text-xs text-right font-semibold text-red-600" rowspan="{{ item_count }}">
                                {% if invoice.payment_status == 'paid' %}
                                ₹0.00
                                {% else %}
                                ₹{{ "{:,.2f}".format((invoice.balance_amount or invoice.total_amount) + invoice.get('interest_amount', 0)) }}
                                {% endif %}
                            </td>
                            <td class="px-2 py-2 text-xs text-center" rowspan="{{ item_count }}">
                                <span class="px-2 py-1 text-xs rounded {% if invoice.payment_status == 'paid' %}bg-green-100 text-green-700{% elif invoice.payment_status == 'partial' %}bg-yellow-100 text-yellow-700{% else %}bg-red-100 text-red-700{% endif %}">
                                    {{ invoice.payment_status|title }}
                                </span>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="15" class="px-4 py-8 text-center text-gray-500">No records found</td>
                        </tr>
                    {% endfor %}
                </tbody>
                {% if invoices %}
                <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                    <tr>
                        <td colspan="12" class="px-2 py-2 text-xs text-right font-semibold">Grand Total:</td>
                        <td class="px-2 py-2 text-xs text-right font-semibold">₹{{ "{:,.2f}".format(total_sales) }}</td>
                        <td class="px-2 py-2 text-xs text-right font-semibold text-green-600">₹{{ "{:,.2f}".format(total_paid) }}</td>
                        <td class="px-2 py-2 text-xs text-right font-semibold text-orange-600">₹{{ "{:,.2f}".format(total_interest or 0) }}</td>
                        <td class="px-2 py-2 text-xs text-right font-semibold text-red-600">₹{{ "{:,.2f}".format(total_outstanding or 0) }}</td>
                        <td></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="mt-4 text-gray-500">No invoices found for the selected filters</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
@media print {
    .no-print { display: none !important; }
    body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
}
</style>
{% endblock %}
