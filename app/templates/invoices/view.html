{% extends "base.html" %}

{% block title %}Invoice #{{ invoice.invoice_no }} - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-4">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Invoice #{{ invoice.invoice_no }}</h1>
            <p class="text-sm text-gray-600">{{ invoice.invoice_date.strftime('%d %b %Y') if invoice.invoice_date else '' }}</p>
        </div>
        <div class="flex gap-2">
            <a href="/invoices/{{ invoice._id }}/edit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Edit</a>
            <a href="/invoices/{{ invoice._id }}/print" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Print Invoice</a>
            <button onclick="deleteInvoice()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
            <a href="/invoices" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200">Back</a>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 space-y-6">
        <div>
            <h3 class="text-lg font-semibold mb-3 border-b pb-2">Invoice Details</h3>
            <div class="grid grid-cols-3 gap-4 text-sm">
                <div><span class="text-gray-600">Invoice No:</span> <span class="font-medium">{{ invoice.invoice_no }}</span></div>
                <div><span class="text-gray-600">Challan No:</span> <span class="font-medium">{{ invoice.challan_no }}</span></div>
                <div><span class="text-gray-600">Date:</span> <span class="font-medium">{{ invoice.invoice_date.strftime('%d %b %Y') if invoice.invoice_date else '-' }}</span></div>
                <div><span class="text-gray-600">Customer:</span> <span class="font-medium">{{ invoice.customer_name }}</span></div>
                <div><span class="text-gray-600">Status:</span> <span class="font-medium">{{ invoice.status|title }}</span></div>
                <div><span class="text-gray-600">Payment Status:</span> <span class="font-medium">{{ invoice.payment_status|title }}</span></div>
            </div>
        </div>

        <div>
            <h3 class="text-lg font-semibold mb-3 border-b pb-2">Items</h3>
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Quality</th>
                        <th class="px-4 py-2 text-right">Taka</th>
                        <th class="px-4 py-2 text-right">Meters</th>
                        <th class="px-4 py-2 text-right">Rate</th>
                        <th class="px-4 py-2 text-right">Amount</th>
                        <th class="px-4 py-2 text-right">GST %</th>
                        <th class="px-4 py-2 text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.get('items', []) %}
                    <tr class="border-b">
                        <td class="px-4 py-2">{{ item.get('quality') }}</td>
                        <td class="px-4 py-2 text-right">{{ item.get('total_taka') }}</td>
                        <td class="px-4 py-2 text-right">{{ "%.2f"|format(item.get('meters', 0)) }}</td>
                        <td class="px-4 py-2 text-right">{{ "%.2f"|format(item.get('rate_per_meter', 0)) }}</td>
                        <td class="px-4 py-2 text-right">{{ "%.2f"|format(item.get('taxable_amount', 0)) }}</td>
                        <td class="px-4 py-2 text-right">{{ item.get('gst_rate') }}%</td>
                        <td class="px-4 py-2 text-right font-medium">₹{{ "%.2f"|format(item.get('taxable_amount', 0) + item.get('cgst', 0) + item.get('sgst', 0) + item.get('igst', 0)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div>
            <h3 class="text-lg font-semibold mb-3 border-b pb-2">Amount Details</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-600">Subtotal:</span> <span class="font-medium">₹{{ "%.2f"|format(invoice.get('items', [])|sum(attribute='taxable_amount')) }}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">CGST:</span> <span class="font-medium">₹{{ "%.2f"|format(invoice.get('items', [])|sum(attribute='cgst')) }}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">SGST:</span> <span class="font-medium">₹{{ "%.2f"|format(invoice.get('items', [])|sum(attribute='sgst')) }}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">IGST:</span> <span class="font-medium">₹{{ "%.2f"|format(invoice.get('items', [])|sum(attribute='igst')) }}</span></div>
                <div class="flex justify-between border-t pt-2"><span class="text-gray-600">Total Amount:</span> <span class="font-medium text-lg">₹{{ "%.2f"|format(invoice.get('total_amount', 0)) }}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">Balance:</span> <span class="font-medium">₹{{ "%.2f"|format(invoice.get('balance_amount', invoice.get('total_amount', 0))) }}</span></div>
            </div>
        </div>

        {% if invoice.notes %}
        <div>
            <h3 class="text-lg font-semibold mb-3 border-b pb-2">Notes</h3>
            <p class="text-sm text-gray-700">{{ invoice.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function deleteInvoice() {
    if (confirm('Are you sure you want to delete this invoice?')) {
        fetch('/invoices/{{ invoice._id }}', {
            method: 'DELETE'
        }).then(res => {
            if (res.ok) {
                window.location.href = '/invoices';
            } else {
                alert('Failed to delete invoice');
            }
        });
    }
}
</script>
{% endblock %}
