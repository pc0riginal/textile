{% extends "base.html" %}

{% block title %}Edit Party - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-4 px-4 md:px-0" x-data="partyForm()">
    <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Edit Party</h1>
        <p class="text-sm text-gray-600">Update party master data</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 md:p-6">
        <form method="POST" action="/parties/{{ party._id }}/edit" @submit="validateForm" class="space-y-4 md:space-y-6">
            <!-- Party Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Party Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Name *</label>
                        <input type="text" name="name" x-model="name" value="{{ party.name }}" required autofocus @input="nameError = ''" @blur="if(!name.trim()) nameError = 'Party Name is required'" :class="nameError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500">
                        <span x-show="nameError" x-text="nameError" class="text-xs text-red-600 block mt-1"></span>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Type *</label>
                        <input type="hidden" name="party_type" x-model="partyType" required>
                        <div class="relative">
                            <input type="text" x-model="partyTypeSearch" @input="filterPartyTypes" @focus="showPartyTypeDropdown = true; filterPartyTypes()" @click="showPartyTypeDropdown = true; filterPartyTypes()" @blur="setTimeout(() => showPartyTypeDropdown = false, 200)" @keydown="handlePartyTypeKeydown($event)" placeholder="Search type..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <div x-show="showPartyTypeDropdown && filteredPartyTypes.length > 0" x-cloak class="absolute z-50 w-full mt-1 bg-white border rounded shadow-lg max-h-48 overflow-auto">
                                <template x-for="(pt, idx) in filteredPartyTypes" :key="pt.value">
                                    <div @mousedown.prevent @click="selectPartyType(pt)" :class="idx === partyTypeSelectedIndex ? 'bg-blue-100' : 'hover:bg-blue-50'" class="px-3 py-1.5 cursor-pointer text-sm" x-text="pt.label"></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Code</label>
                        <input type="text" name="party_code" value="{{ party.party_code }}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50" readonly>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                        <textarea name="delivery_address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">{{ party.delivery_address or '' }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Delivery)</label>
                        <input type="text" name="delivery_city" value="{{ party.delivery_city or '' }}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pin Code</label>
                        <input type="text" name="delivery_pincode" x-model="deliveryPincode" value="{{ party.delivery_pincode or '' }}" @input="validatePincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="pincodeError" class="text-xs text-red-600 mt-1" x-text="pincodeError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <select name="delivery_state" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            {% for state in indian_states %}
                            <option value="{{ state }}" {% if party.delivery_state == state %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GST No.</label>
                        <div class="relative">
                            <input type="text" name="gstin" x-model="gstin" value="{{ party.gstin or '' }}" @input="gstin = gstin.toUpperCase(); validateGST(); if(gstin.length === 15 && !gstError) fetchGSTDetails()" @blur="if(gstin.length === 15 && !gstError) fetchGSTDetails()" maxlength="15" class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 uppercase" :class="gstError ? 'border-red-500' : 'border-gray-300'">
                            <div x-show="gstLoading" class="absolute right-2 top-1/2 -translate-y-1/2">
                                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                            </div>
                            <div x-show="gstVerified" class="absolute right-2 top-1/2 -translate-y-1/2 text-green-500">✓</div>
                        </div>
                        <p x-show="gstError" class="text-xs text-red-600 mt-1" x-text="gstError"></p>
                        <p x-show="gstInfo" class="text-xs text-green-600 mt-1" x-text="gstInfo"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                        <input type="text" name="phone" x-model="phone" value="{{ party.contact.phone }}" @input="validateMobile" maxlength="10" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="mobileError" class="text-xs text-red-600 mt-1" x-text="mobileError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
                        <div class="flex gap-2">
                            <select name="broker_id" x-model="brokerId" @change="toggleBrokerage" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="">NONE</option>
                                {% for broker in brokers %}
                                <option value="{{ broker._id }}" {% if party.broker_id == broker._id %}selected{% endif %}>{{ broker.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" @click="showBrokerModal = true" class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">+ Add</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brokerage</label>
                        <input type="number" step="0.01" name="brokerage" x-model="brokerage" value="{{ party.brokerage or 0 }}" :disabled="!brokerId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" :class="!brokerId ? 'bg-gray-100' : ''">
                    </div>
                </div>
            </div>

            <!-- Office Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Office Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Office Address</label>
                        <textarea name="office_address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">{{ party.office_address or '' }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Office)</label>
                        <input type="text" name="office_city" value="{{ party.office_city or '' }}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" value="{{ party.contact.email or '' }}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Financial Settings -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Financial Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dhara Day</label>
                        <input type="number" name="dhara_day" x-model="dharaDay" value="{{ party.dhara_day or 0 }}" @input="validateDharaDay" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="dharaDayError" class="text-xs text-red-600 mt-1" x-text="dharaDayError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Interest (%)</label>
                        <input type="number" step="0.01" name="interest" x-model="interest" value="{{ party.interest or 0 }}" @input="validateInterest" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="interestError" class="text-xs text-red-600 mt-1" x-text="interestError"></p>
                    </div>
                </div>
            </div>

            <!-- Form Buttons -->
            <div class="flex flex-col sm:flex-row items-center justify-end gap-2 sm:gap-3 pt-4 border-t">
                <a href="/parties" class="w-full sm:w-auto text-center px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Cancel</a>
                <button type="submit" class="w-full sm:w-auto px-6 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">Update Party</button>
            </div>
        </form>
    </div>

    <!-- Broker Modal -->
    <div x-show="showBrokerModal" x-effect="if(showBrokerModal) { brokerNameError = ''; brokerPhoneError = ''; $nextTick(() => $refs.brokerNameInput.focus()); }" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md" @click.away="showBrokerModal = false">
            <h3 class="text-lg font-semibold mb-4">Add New Broker</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Broker Name *</label>
                    <input type="text" x-ref="brokerNameInput" x-model="newBrokerName" @input="brokerNameError = ''" :class="brokerNameError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <span x-show="brokerNameError" x-text="brokerNameError" class="text-xs text-red-600 block"></span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                    <input type="text" x-model="newBrokerPhone" @input="brokerPhoneError = ''" maxlength="10" :class="brokerPhoneError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <span x-show="brokerPhoneError" x-text="brokerPhoneError" class="text-xs text-red-600 block"></span>
                </div>
            </div>
            <div class="flex gap-3 justify-end mt-6">
                <button type="button" @click="showBrokerModal = false" class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                <button type="button" @click="saveBroker" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function partyForm() {
    return {
        name: '{{ party.name }}',
        phone: '{{ party.contact.phone }}',
        gstin: '{{ party.gstin or "" }}',
        partyType: '{{ party.party_type }}',
        partyTypeSearch: '{{ {"customer":"Customer","supplier":"Supplier","both":"Both","broker":"Broker","transporter":"Transporter"}.get(party.party_type, "") }}',
        partyTypes: [
            {value: 'customer', label: 'Customer'},
            {value: 'supplier', label: 'Supplier'},
            {value: 'both', label: 'Both'},
            {value: 'broker', label: 'Broker'},
            {value: 'transporter', label: 'Transporter'}
        ],
        filteredPartyTypes: [],
        showPartyTypeDropdown: false,
        partyTypeSelectedIndex: 0,
        deliveryPincode: '{{ party.delivery_pincode or "" }}',
        brokerId: '{{ party.broker_id or "" }}',
        brokerage: {{ party.brokerage or 0 }},
        dharaDay: '{{ party.dhara_day or 0 }}',
        interest: '{{ party.interest or 0 }}',
        mobileError: '',
        gstError: '',
        gstLoading: false,
        gstVerified: false,
        gstInfo: '',
        pincodeError: '',
        dharaDayError: '',
        interestError: '',
        showBrokerModal: false,
        newBrokerName: '',
        newBrokerPhone: '',
        nameError: '',
        brokerNameError: '',
        brokerPhoneError: '',

        filterPartyTypes() {
            const search = (this.partyTypeSearch || '').toLowerCase();
            if (search) {
                this.filteredPartyTypes = this.partyTypes.filter(pt => pt.label.toLowerCase().includes(search));
            } else {
                this.filteredPartyTypes = [...this.partyTypes];
            }
            this.partyTypeSelectedIndex = 0;
        },

        handlePartyTypeKeydown(e) {
            if (!this.showPartyTypeDropdown && (e.key === 'ArrowDown' || e.key === 'Enter')) {
                this.showPartyTypeDropdown = true;
                this.filterPartyTypes();
                e.preventDefault();
                return;
            }
            if (!this.showPartyTypeDropdown) return;
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.partyTypeSelectedIndex = Math.min(this.partyTypeSelectedIndex + 1, this.filteredPartyTypes.length - 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.partyTypeSelectedIndex = Math.max(this.partyTypeSelectedIndex - 1, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.partyTypeSelectedIndex >= 0 && this.partyTypeSelectedIndex < this.filteredPartyTypes.length) {
                        this.selectPartyType(this.filteredPartyTypes[this.partyTypeSelectedIndex]);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    this.showPartyTypeDropdown = false;
                    break;
            }
        },

        selectPartyType(pt) {
            this.partyType = pt.value;
            this.partyTypeSearch = pt.label;
            this.showPartyTypeDropdown = false;
        },

        validateMobile() {
            if (this.phone && !/^\d{10}$/.test(this.phone)) {
                this.mobileError = 'Mobile number must be 10 digits';
            } else {
                this.mobileError = '';
            }
        },

        validateGST() {
            if (this.gstin && this.gstin.length !== 15) {
                this.gstError = 'GST number must be 15 characters';
                this.gstVerified = false;
                this.gstInfo = '';
            } else {
                this.gstError = '';
            }
        },

        async fetchGSTDetails() {
            if (!this.gstin || this.gstin.length !== 15 || this.gstError) return;
            
            // Use the new GST verification modal with captcha
            const gstVerification = new GSTVerification();
            
            gstVerification.showVerificationModal(this.gstin, (data) => {
                // Auto-fill form with verified data
                if (!this.name.trim() && (data.trade_name || data.legal_name)) {
                    this.name = data.trade_name || data.legal_name;
                }
                
                const addrField = document.querySelector('textarea[name="delivery_address"]');
                if (addrField && !addrField.value.trim() && data.address) {
                    addrField.value = data.address;
                }
                
                // Auto-fill city
                const cityField = document.querySelector('input[name="delivery_city"]');
                if (cityField && !cityField.value.trim() && data.city) {
                    cityField.value = data.city;
                }
                
                if (data.pincode && !this.deliveryPincode.trim()) {
                    this.deliveryPincode = data.pincode;
                }
                
                if (data.state) {
                    const stateUpper = data.state.toUpperCase();
                    const stateSelect = document.querySelector('select[name="delivery_state"]');
                    if (stateSelect) {
                        for (let opt of stateSelect.options) {
                            if (opt.value.toUpperCase() === stateUpper || opt.value.toUpperCase().includes(stateUpper)) {
                                stateSelect.value = opt.value;
                                break;
                            }
                        }
                    }
                }
                
                this.gstVerified = true;
                this.gstInfo = `✓ ${data.legal_name || data.trade_name}`;
                this.gstError = '';
                
                if (typeof showToast === 'function') {
                    showToast('GST details verified and auto-filled successfully', 'success');
                }
            });
        },

        validatePincode() {
            if (this.deliveryPincode && !/^\d{6}$/.test(this.deliveryPincode)) {
                this.pincodeError = 'Pin code must be 6 digits';
            } else {
                this.pincodeError = '';
            }
        },

        validateDharaDay() {
            if (this.dharaDay && !Number.isInteger(parseFloat(this.dharaDay))) {
                this.dharaDayError = 'Dhara Day must be an integer';
            } else {
                this.dharaDayError = '';
            }
        },

        validateInterest() {
            if (this.interest && isNaN(parseFloat(this.interest))) {
                this.interestError = 'Interest must be a numeric value';
            } else {
                this.interestError = '';
            }
        },

        toggleBrokerage() {
            if (!this.brokerId) {
                this.brokerage = 0;
            }
        },

        validateForm(e) {
            if (!this.name.trim()) {
                e.preventDefault();
                this.nameError = 'Party Name is required';
                return false;
            }

            if (this.mobileError || this.gstError || this.pincodeError || this.dharaDayError || this.interestError) {
                e.preventDefault();
                return false;
            }

            return true;
        },

        async saveBroker() {
            this.brokerNameError = '';
            this.brokerPhoneError = '';
            let hasError = false;
            if (!this.newBrokerName.trim()) { this.brokerNameError = 'Broker Name is required'; hasError = true; }
            if (this.newBrokerPhone && this.newBrokerPhone.trim() && !/^\d{10}$/.test(this.newBrokerPhone.trim())) { this.brokerPhoneError = 'Mobile must be 10 digits'; hasError = true; }
            if (hasError) return;

            try {
                const res = await fetch('/parties/quick-add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: this.newBrokerName,
                        phone: this.newBrokerPhone || '',
                        party_type: 'broker'
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    const select = document.querySelector('select[name="broker_id"]');
                    const option = document.createElement('option');
                    option.value = data.id;
                    option.text = data.name;
                    option.selected = true;
                    select.add(option);
                    this.brokerId = data.id;
                    this.showBrokerModal = false;
                    this.newBrokerName = '';
                } else {
                    alert('Failed to add broker');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    }
}
</script>

<!-- GST Verification Script -->
<script src="/static/js/gst-verification.js"></script>

{% endblock %}
