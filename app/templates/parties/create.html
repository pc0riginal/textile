{% extends "base.html" %}

{% block title %}Party Name Form - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-4 px-4 md:px-0" x-data="partyForm()">
    <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Party Name Form</h1>
        <p class="text-sm text-gray-600">Add or manage party master data</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 md:p-6">
        {% if error %}
        <div class="mb-3 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-md text-xs">
            {{ error }}
        </div>
        {% endif %}

        <form method="POST" action="/parties/create" @submit="validateForm" class="space-y-4 md:space-y-6">
            {% if redirect_url %}
            <input type="hidden" name="redirect_url" value="{{ redirect_url }}">
            {% endif %}

            <!-- Party Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Party Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Name *</label>
                        <input type="text" name="name" x-model="name" required autofocus @input="nameError = ''" @blur="if(!name.trim()) nameError = 'Party Name is required'" :class="nameError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500">
                        <span x-show="nameError" x-text="nameError" class="text-xs text-red-600 block mt-1"></span>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Type *</label>
                        <select name="party_type" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Type</option>
                            <option value="customer" {% if default_type == 'customer' %}selected{% endif %}>Customer</option>
                            <option value="supplier" {% if default_type == 'supplier' %}selected{% endif %}>Supplier</option>
                            <option value="both" {% if default_type == 'both' %}selected{% endif %}>Both</option>
                            <option value="broker" {% if default_type == 'broker' %}selected{% endif %}>Broker</option>
                            <option value="transporter" {% if default_type == 'transporter' %}selected{% endif %}>Transporter</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Code</label>
                        <input type="text" name="party_code" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50" placeholder="Auto-generated">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                        <textarea name="delivery_address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Delivery)</label>
                        <input type="text" name="delivery_city" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pin Code</label>
                        <input type="text" name="delivery_pincode" x-model="deliveryPincode" @input="validatePincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="pincodeError" class="text-xs text-red-600 mt-1" x-text="pincodeError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <select name="delivery_state" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            {% for state in indian_states %}
                            <option value="{{ state }}" {% if state == 'GUJARAT' %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GST No.</label>
                        <input type="text" name="gstin" x-model="gstin" @input="gstin = gstin.toUpperCase(); validateGST()" maxlength="15" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 uppercase" placeholder="22AAAAA0000A1Z5">
                        <p x-show="gstError" class="text-xs text-red-600 mt-1" x-text="gstError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                        <input type="text" name="phone" x-model="phone" @input="validateMobile" maxlength="10" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="mobileError" class="text-xs text-red-600 mt-1" x-text="mobileError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
                        <div class="flex gap-2">
                            <select name="broker_id" x-model="brokerId" @change="toggleBrokerage" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="">NONE</option>
                                {% for broker in brokers %}
                                <option value="{{ broker._id }}">{{ broker.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" @click="showBrokerModal = true" class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">+ Add</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brokerage</label>
                        <input type="number" step="0.01" name="brokerage" x-model="brokerage" :disabled="!brokerId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" :class="!brokerId ? 'bg-gray-100' : ''">
                    </div>
                </div>
            </div>

            <!-- Office Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Office Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Office Address</label>
                        <textarea name="office_address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Office)</label>
                        <input type="text" name="office_city" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pin Code (Office)</label>
                        <input type="text" name="office_pincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State (Office)</label>
                        <select name="office_state" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            {% for state in indian_states %}
                            <option value="{{ state }}" {% if state == 'GUJARAT' %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Financial Settings -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Financial Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dhara Day</label>
                        <input type="number" name="dhara_day" x-model="dharaDay" @input="validateDharaDay" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="0">
                        <p x-show="dharaDayError" class="text-xs text-red-600 mt-1" x-text="dharaDayError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Interest (%)</label>
                        <input type="number" step="0.01" name="interest" x-model="interest" @input="validateInterest" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                        <p x-show="interestError" class="text-xs text-red-600 mt-1" x-text="interestError"></p>
                    </div>
                </div>
            </div>

            <!-- Form Buttons -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-2 sm:gap-3 pt-4 border-t">
                <div class="flex gap-2">
                    <button type="button" @click="resetForm" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Add New</button>
                    <a href="/parties" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 inline-block">Party Report</a>
                </div>
                <div class="flex gap-2">
                    <a href="/parties" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 inline-block">Cancel</a>
                    <button type="submit" class="px-6 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Party</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Broker Modal -->
    <div x-show="showBrokerModal" x-effect="if(showBrokerModal) { brokerNameError = ''; brokerPhoneError = ''; $nextTick(() => $refs.brokerNameInput.focus()); }" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md" @click.away="showBrokerModal = false">
            <h3 class="text-lg font-semibold mb-4">Add New Broker</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Broker Name *</label>
                    <input type="text" x-ref="brokerNameInput" x-model="newBrokerName" @input="brokerNameError = ''" :class="brokerNameError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <span x-show="brokerNameError" x-text="brokerNameError" class="text-xs text-red-600 block"></span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                    <input type="text" x-model="newBrokerPhone" @input="brokerPhoneError = ''" maxlength="10" :class="brokerPhoneError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <span x-show="brokerPhoneError" x-text="brokerPhoneError" class="text-xs text-red-600 block"></span>
                </div>
            </div>
            <div class="flex gap-3 justify-end mt-6">
                <button type="button" @click="showBrokerModal = false" class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                <button type="button" @click="saveBroker" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function partyForm() {
    return {
        name: '',
        nameError: '',
        phone: '',
        gstin: '',
        deliveryPincode: '',
        brokerId: '',
        brokerage: 0,
        dharaDay: '',
        interest: '',
        mobileError: '',
        gstError: '',
        pincodeError: '',
        dharaDayError: '',
        interestError: '',
        showBrokerModal: false,
        newBrokerName: '',
        newBrokerPhone: '',
        brokerNameError: '',
        brokerPhoneError: '',

        validateMobile() {
            if (this.phone && !/^\d{10}$/.test(this.phone)) {
                this.mobileError = 'Mobile number must be 10 digits';
            } else {
                this.mobileError = '';
            }
        },

        validateGST() {
            if (this.gstin && this.gstin.length !== 15) {
                this.gstError = 'GST number must be 15 characters';
            } else {
                this.gstError = '';
            }
        },

        validatePincode() {
            if (this.deliveryPincode && !/^\d{6}$/.test(this.deliveryPincode)) {
                this.pincodeError = 'Pin code must be 6 digits';
            } else {
                this.pincodeError = '';
            }
        },

        validateDharaDay() {
            if (this.dharaDay && !Number.isInteger(parseFloat(this.dharaDay))) {
                this.dharaDayError = 'Dhara Day must be an integer';
            } else {
                this.dharaDayError = '';
            }
        },

        validateInterest() {
            if (this.interest && isNaN(parseFloat(this.interest))) {
                this.interestError = 'Interest must be a numeric value';
            } else {
                this.interestError = '';
            }
        },

        toggleBrokerage() {
            if (!this.brokerId) {
                this.brokerage = 0;
            }
        },

        validateForm(e) {
            this.nameError = '';
            if (!this.name.trim()) {
                e.preventDefault();
                this.nameError = 'Party Name is required';
                return false;
            }

            if (this.mobileError || this.gstError || this.pincodeError || this.dharaDayError || this.interestError) {
                e.preventDefault();
                return false;
            }

            return true;
        },

        async saveBroker() {
            this.brokerNameError = '';
            this.brokerPhoneError = '';
            let hasError = false;
            if (!this.newBrokerName.trim()) { this.brokerNameError = 'Broker Name is required'; hasError = true; }
            if (this.newBrokerPhone && this.newBrokerPhone.trim() && !/^\d{10}$/.test(this.newBrokerPhone.trim())) { this.brokerPhoneError = 'Mobile must be 10 digits'; hasError = true; }
            if (hasError) return;

            try {
                const res = await fetch('/parties/quick-add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: this.newBrokerName,
                        phone: this.newBrokerPhone || '',
                        party_type: 'broker'
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    const select = document.querySelector('select[name="broker_id"]');
                    const option = document.createElement('option');
                    option.value = data.id;
                    option.text = data.name;
                    option.selected = true;
                    select.add(option);
                    this.brokerId = data.id;
                    this.showBrokerModal = false;
                    this.newBrokerName = '';
                    this.newBrokerPhone = '';
                } else {
                    alert('Failed to add broker');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        },

        resetForm() {
            this.name = '';
            this.phone = '';
            this.gstin = '';
            this.deliveryPincode = '';
            this.brokerId = '';
            this.brokerage = 0;
            this.dharaDay = '';
            this.interest = '';
            document.querySelector('form').reset();
        }
    }
}
</script>
{% endblock %}