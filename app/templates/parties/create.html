{% extends "base.html" %}

{% block title %}Party Name Form - Textile ERP{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-4 px-4 md:px-0" x-data="partyForm()">
    <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Party Name Form</h1>
        <p class="text-sm text-gray-600">Add or manage party master data</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 md:p-6">
        {% if error %}
        <div class="mb-3 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-md text-xs">
            {{ error }}
        </div>
        {% endif %}

        <form method="POST" action="/parties/create" @submit="validateForm" class="space-y-4 md:space-y-6">
            {% if redirect_url %}
            <input type="hidden" name="redirect_url" value="{{ redirect_url }}">
            {% endif %}

            <!-- GST Auto-fill Section -->
            <div x-show="!gstVerified" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="text-sm font-semibold text-blue-800">Quick Fill with GST Number</h3>
                </div>
                <p class="text-xs text-blue-700 mb-3">Enter GST number to auto-fill party name, address, and other details from the GST portal.</p>
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input type="text" x-model="gstin" 
                            @input="gstin = gstin.toUpperCase(); validateGST();" 
                            @paste="$nextTick(() => { gstin = gstin.toUpperCase(); validateGST(); })"
                            maxlength="15" 
                            class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 uppercase font-mono" 
                            :class="gstError ? 'border-red-500' : 'border-gray-300'" 
                            placeholder="Enter 15-digit GSTIN">
                    </div>
                    <button type="button" @click="fetchGSTDetails()" 
                        :disabled="!gstin || gstin.length !== 15 || gstError || gstModalOpen"
                        class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Verify & Auto-fill
                    </button>
                </div>
                <p x-show="gstError" class="text-xs text-red-600 mt-1" x-text="gstError"></p>
                <p class="text-xs text-blue-600 mt-1">Or skip this and fill the form manually below.</p>
            </div>

            <!-- GST Verified Banner -->
            <div x-show="gstVerified" class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-sm font-semibold text-green-800">GST Verified</span>
                        <span class="text-xs text-green-700 font-mono" x-text="gstin"></span>
                    </div>
                    <button type="button" @click="gstVerified = false; gstInfo = ''" class="text-xs text-green-700 hover:text-green-900 underline">Change</button>
                </div>
                <p x-show="gstInfo" class="text-xs text-green-700 mt-1" x-text="gstInfo"></p>
            </div>

            <!-- Party Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Party Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Name *</label>
                        <input type="text" name="name" x-model="name" required autofocus @input="nameError = ''" @blur="if(!name.trim()) nameError = 'Party Name is required'" :class="nameError ? 'border-red-500' : 'border-gray-300'" class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500">
                        <span x-show="nameError" x-text="nameError" class="text-xs text-red-600 block mt-1"></span>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Type *</label>
                        <input type="hidden" name="party_type" x-model="partyType" required>
                        <div class="relative">
                            <input type="text" x-model="partyTypeSearch" @input="filterPartyTypes" @focus="showPartyTypeDropdown = true; filterPartyTypes()" @click="showPartyTypeDropdown = true; filterPartyTypes()" @blur="setTimeout(() => showPartyTypeDropdown = false, 200)" @keydown="handlePartyTypeKeydown($event)" placeholder="Search type..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <div x-show="showPartyTypeDropdown && filteredPartyTypes.length > 0" x-cloak class="absolute z-50 w-full mt-1 bg-white border rounded shadow-lg max-h-48 overflow-auto">
                                <template x-for="(pt, idx) in filteredPartyTypes" :key="pt.value">
                                    <div @mousedown.prevent @click="selectPartyType(pt)" :class="idx === partyTypeSelectedIndex ? 'bg-blue-100' : 'hover:bg-blue-50'" class="px-3 py-1.5 cursor-pointer text-sm" x-text="pt.label"></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Party Code</label>
                        <input type="text" name="party_code" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50" placeholder="Auto-generated">
                    </div>

                    <!-- Hidden GST field for form submission -->
                    <input type="hidden" name="gstin" :value="gstin">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GST No.</label>
                        <div class="relative">
                            <input type="text" x-model="gstin" 
                                @input="gstin = gstin.toUpperCase(); validateGST();" 
                                maxlength="15" 
                                class="w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 uppercase font-mono" 
                                :class="gstError ? 'border-red-500' : (gstVerified ? 'border-green-400 bg-green-50' : 'border-gray-300')" 
                                placeholder="22AAAAA0000A1Z5">
                            <div x-show="gstVerified" class="absolute right-2 top-1/2 -translate-y-1/2 text-green-500">✓</div>
                        </div>
                        <p x-show="gstError" class="text-xs text-red-600 mt-1" x-text="gstError"></p>
                        <div x-show="gstin.length === 15 && !gstError && !gstVerified" class="mt-1">
                            <button type="button" @click="fetchGSTDetails()" class="text-xs text-blue-600 hover:text-blue-800 underline">Verify & Auto-fill from GST portal</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PAN</label>
                        <input type="text" name="pan" x-model="pan" maxlength="10" 
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 uppercase font-mono" 
                            :class="gstVerified && pan ? 'bg-green-50 border-green-400' : ''"
                            placeholder="AAAAA0000A">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                        <textarea name="delivery_address" x-model="deliveryAddress" @input="syncToOffice" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Delivery)</label>
                        <input type="text" name="delivery_city" x-model="deliveryCity" @input="syncToOffice" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pin Code</label>
                        <input type="text" name="delivery_pincode" x-model="deliveryPincode" @input="validatePincode; syncToOffice" maxlength="6" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="pincodeError" class="text-xs text-red-600 mt-1" x-text="pincodeError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <select name="delivery_state" x-model="deliveryState" @change="syncToOffice" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            {% for state in indian_states %}
                            <option value="{{ state }}" {% if state == 'GUJARAT' %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                        <input type="text" name="phone" x-model="phone" @input="validateMobile" maxlength="10" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p x-show="mobileError" class="text-xs text-red-600 mt-1" x-text="mobileError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
                        <div class="flex gap-2">
                            <select name="broker_id" x-ref="brokerSelect" x-model="brokerId" @change="toggleBrokerage" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="">NONE</option>
                                {% for broker in brokers %}
                                <option value="{{ broker._id }}">{{ broker.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" @click="addBrokerRedirect()" class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">+ Add</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brokerage</label>
                        <input type="number" step="0.01" name="brokerage" x-model="brokerage" :disabled="!brokerId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" :class="!brokerId ? 'bg-gray-100' : ''">
                    </div>
                </div>
            </div>

            <!-- Office Details -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Office Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Office Address</label>
                        <textarea name="office_address" x-model="officeAddress" @input="officeTouched = true" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City (Office)</label>
                        <input type="text" name="office_city" x-model="officeCity" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pin Code (Office)</label>
                        <input type="text" name="office_pincode" x-model="officePincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State (Office)</label>
                        <select name="office_state" x-model="officeState" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            {% for state in indian_states %}
                            <option value="{{ state }}" {% if state == 'GUJARAT' %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Financial Settings -->
            <div>
                <h3 class="text-base font-semibold text-gray-900 mb-3 border-b pb-2">Financial Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dhara Day</label>
                        <input type="number" name="dhara_day" x-model="dharaDay" @input="validateDharaDay" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="0">
                        <p x-show="dharaDayError" class="text-xs text-red-600 mt-1" x-text="dharaDayError"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Interest (%)</label>
                        <input type="number" step="0.01" name="interest" x-model="interest" @input="validateInterest" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                        <p x-show="interestError" class="text-xs text-red-600 mt-1" x-text="interestError"></p>
                    </div>
                </div>
            </div>

            <!-- Form Buttons -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-2 sm:gap-3 pt-4 border-t">
                <div class="flex gap-2">
                    <button type="button" @click="resetForm" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Add New</button>
                    <a href="/parties" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 inline-block">Party Report</a>
                </div>
                <div class="flex gap-2">
                    <a href="/parties" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 inline-block">Cancel</a>
                    <button type="submit" class="px-6 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Party</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function partyForm() {
    return {
        name: '{{ default_name or "" }}',
        nameError: '',
        partyType: '{{ default_type or "" }}',
        partyTypeSearch: '{{ {"customer":"Customer","supplier":"Supplier","both":"Both","broker":"Broker","transporter":"Transporter"}.get(default_type, "") }}',
        partyTypes: [
            {value: 'customer', label: 'Customer'},
            {value: 'supplier', label: 'Supplier'},
            {value: 'both', label: 'Both'},
            {value: 'broker', label: 'Broker'},
            {value: 'transporter', label: 'Transporter'}
        ],
        filteredPartyTypes: [],
        showPartyTypeDropdown: false,
        partyTypeSelectedIndex: 0,
        phone: '',
        gstin: '',
        pan: '',
        deliveryAddress: '',
        deliveryCity: 'Surat',
        deliveryPincode: '',
        deliveryState: 'GUJARAT',
        officeAddress: '',
        officeCity: 'Surat',
        officePincode: '',
        officeState: 'GUJARAT',
        officeTouched: false,
        brokerId: '',
        brokerage: 0,
        dharaDay: '',
        interest: '',
        mobileError: '',
        gstError: '',
        gstLoading: false,
        gstVerified: false,
        gstInfo: '',
        gstModalOpen: false,
        pincodeError: '',
        dharaDayError: '',
        interestError: '',

        init() {
            if (sessionStorage.getItem('focusBrokerSelect')) {
                sessionStorage.removeItem('focusBrokerSelect');
                this.$nextTick(() => {
                    if (this.$refs.brokerSelect) this.$refs.brokerSelect.focus();
                });
            }
        },

        filterPartyTypes() {
            const search = (this.partyTypeSearch || '').toLowerCase();
            if (search) {
                this.filteredPartyTypes = this.partyTypes.filter(pt => pt.label.toLowerCase().includes(search));
            } else {
                this.filteredPartyTypes = [...this.partyTypes];
            }
            this.partyTypeSelectedIndex = 0;
        },

        handlePartyTypeKeydown(e) {
            if (!this.showPartyTypeDropdown && (e.key === 'ArrowDown' || e.key === 'Enter')) {
                this.showPartyTypeDropdown = true;
                this.filterPartyTypes();
                e.preventDefault();
                return;
            }
            if (!this.showPartyTypeDropdown) return;
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.partyTypeSelectedIndex = Math.min(this.partyTypeSelectedIndex + 1, this.filteredPartyTypes.length - 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.partyTypeSelectedIndex = Math.max(this.partyTypeSelectedIndex - 1, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.partyTypeSelectedIndex >= 0 && this.partyTypeSelectedIndex < this.filteredPartyTypes.length) {
                        this.selectPartyType(this.filteredPartyTypes[this.partyTypeSelectedIndex]);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    this.showPartyTypeDropdown = false;
                    break;
            }
        },

        selectPartyType(pt) {
            this.partyType = pt.value;
            this.partyTypeSearch = pt.label;
            this.showPartyTypeDropdown = false;
        },

        validateMobile() {
            if (this.phone && !/^\d{10}$/.test(this.phone)) {
                this.mobileError = 'Mobile number must be 10 digits';
            } else {
                this.mobileError = '';
            }
        },

        validateGST() {
            if (this.gstin && this.gstin.length !== 15) {
                this.gstError = 'GST number must be 15 characters';
                this.gstVerified = false;
                this.gstInfo = '';
            } else if (this.gstin && this.gstin.length === 15) {
                // Validate GSTIN format: 2 digits, 5 letters, 4 digits, 1 letter, 1 digit/letter, Z, 1 alphanumeric
                if (!/^\d{2}[A-Z]{5}\d{4}[A-Z]\d[Z0-9A-J][A-Z\d]$/.test(this.gstin)) {
                    this.gstError = 'Invalid GSTIN format';
                    this.gstVerified = false;
                    this.gstInfo = '';
                } else {
                    this.gstError = '';
                }
            } else {
                this.gstError = '';
            }
        },

        async fetchGSTDetails() {
            if (!this.gstin || this.gstin.length !== 15 || this.gstError || this.gstModalOpen) return;
            
            // Check if GSTVerification is loaded
            if (typeof GSTVerification === 'undefined') {
                console.error('GSTVerification not loaded yet');
                return;
            }
            
            // Set flag to prevent multiple modals
            this.gstModalOpen = true;
            const self = this;
            
            // Use GST verification modal with captcha
            const gstVerification = new GSTVerification();
            
            gstVerification.showVerificationModal(this.gstin, (data) => {
                // Auto-fill party name
                if (!self.name.trim() && (data.trade_name || data.legal_name)) {
                    self.name = data.trade_name || data.legal_name;
                }
                
                // Extract PAN from GSTIN (characters 3-12)
                if (!self.pan.trim() && self.gstin.length === 15) {
                    self.pan = self.gstin.substring(2, 12);
                }
                
                // Auto-fill delivery address
                if (data.address && !self.deliveryAddress.trim()) {
                    self.deliveryAddress = data.address;
                }
                
                // Auto-fill city
                if (data.city) {
                    self.deliveryCity = data.city;
                }
                
                // Auto-fill pincode
                if (data.pincode) {
                    self.deliveryPincode = data.pincode;
                }
                
                // Auto-fill state
                if (data.state) {
                    const stateUpper = data.state.toUpperCase();
                    const stateSelect = document.querySelector('select[name="delivery_state"]');
                    if (stateSelect) {
                        for (let opt of stateSelect.options) {
                            if (opt.value.toUpperCase() === stateUpper || opt.value.toUpperCase().includes(stateUpper)) {
                                self.deliveryState = opt.value;
                                break;
                            }
                        }
                    }
                }
                
                // Sync to office address
                self.syncToOffice();
                
                self.gstVerified = true;
                self.gstInfo = `✓ ${data.legal_name || data.trade_name}`;
                self.gstError = '';
                self.gstModalOpen = false;
                
                if (typeof showToast === 'function') {
                    showToast('GST details verified and auto-filled successfully', 'success');
                }
            });
            
            // Watch for modal removal to reset flag (handles cancel/close/ESC)
            const checkModal = setInterval(() => {
                if (!document.getElementById('gstVerificationModal')) {
                    self.gstModalOpen = false;
                    clearInterval(checkModal);
                }
            }, 500);
        },

        validatePincode() {
            if (this.deliveryPincode && !/^\d{6}$/.test(this.deliveryPincode)) {
                this.pincodeError = 'Pin code must be 6 digits';
            } else {
                this.pincodeError = '';
            }
        },

        validateDharaDay() {
            if (this.dharaDay && !Number.isInteger(parseFloat(this.dharaDay))) {
                this.dharaDayError = 'Dhara Day must be an integer';
            } else {
                this.dharaDayError = '';
            }
        },

        validateInterest() {
            if (this.interest && isNaN(parseFloat(this.interest))) {
                this.interestError = 'Interest must be a numeric value';
            } else {
                this.interestError = '';
            }
        },

        syncToOffice() {
            if (!this.officeTouched) {
                this.officeAddress = this.deliveryAddress;
                this.officeCity = this.deliveryCity;
                this.officePincode = this.deliveryPincode;
                this.officeState = this.deliveryState;
            }
        },

        toggleBrokerage() {
            if (!this.brokerId) {
                this.brokerage = 0;
            }
        },

        validateForm(e) {
            this.nameError = '';
            if (!this.name.trim()) {
                e.preventDefault();
                this.nameError = 'Party Name is required';
                return false;
            }

            if (this.mobileError || this.gstError || this.pincodeError || this.dharaDayError || this.interestError) {
                e.preventDefault();
                return false;
            }

            return true;
        },

        addBrokerRedirect() {
            const params = new URLSearchParams();
            if (this.name) params.set('name', this.name);
            if (this.partyType) params.set('type', this.partyType);
            const currentParams = new URLSearchParams(window.location.search);
            const originalRedirect = currentParams.get('redirect');
            if (originalRedirect) params.set('redirect', originalRedirect);
            const redirectBack = '/parties/create?' + params.toString();
            sessionStorage.setItem('focusBrokerSelect', 'true');
            window.location.href = '/parties/create?type=broker&redirect=' + encodeURIComponent(redirectBack);
        },

        resetForm() {
            this.name = '';
            this.phone = '';
            this.gstin = '';
            this.pan = '';
            this.deliveryPincode = '';
            this.deliveryAddress = '';
            this.deliveryCity = 'Surat';
            this.deliveryState = 'GUJARAT';
            this.officeAddress = '';
            this.officeCity = 'Surat';
            this.officePincode = '';
            this.officeState = 'GUJARAT';
            this.officeTouched = false;
            this.brokerId = '';
            this.brokerage = 0;
            this.dharaDay = '';
            this.interest = '';
            this.gstVerified = false;
            this.gstInfo = '';
            this.gstError = '';
            document.querySelector('form').reset();
        }
    }
}
</script>

<!-- GST Verification Script -->
<script src="/static/js/gst-verification.js"></script>

{% endblock %}